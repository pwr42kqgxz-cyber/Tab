<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Tablature baroque</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  font-family: serif;
  background: white;
  touch-action: none;
}

#toolbar {
  display: flex;
  gap: 8px;
  padding: 6px;
  border-bottom: 1px solid black;
}

button {
  font-size: 14px;
}

#canvas {
  position: relative;
  height: 65vh;
}

.line {
  position: absolute;
  left: 5%;
  right: 5%;
  height: 1px;
  background: black;
}

.symbol {
  position: absolute;
  font-size: 22px;
  user-select: none;
  touch-action: none;
}

.bar {
  position: absolute;
  width: 2px;
  background: black;
}

#palette {
  height: 35vh;
  border-top: 1px solid black;
  padding: 8px;
  display: flex;
  flex-wrap: wrap;
}

.palette-item {
  border: 1px solid black;
  padding: 6px;
  margin: 4px;
  font-size: 18px;
}
</style>
</head>

<body>

<div id="toolbar">
  <button id="toolPlace">‚úçÔ∏è Placer</button>
  <button id="toolSelect">üñê S√©lection</button>
  <button id="toolDelete">üóë Effacer</button>
  <button id="addLine">‚ûï Ligne</button>
  <button id="addBar">‚îÇ Barre</button>
</div>

<div id="canvas"></div>
<div id="palette"></div>

<script>
// ‚õî blocage scroll iOS
document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });

const canvas = document.getElementById("canvas");
const palette = document.getElementById("palette");

let tool = "place";
let selectedSymbol = null;
let selectedElement = null;

const LINE_SPACING = 40;
const WRITE_OFFSET = 18;
const lines = [];

// ================= LIGNES =================
function addLine() {
  const index = lines.length;
  const y = 50 + index * LINE_SPACING;

  const line = document.createElement("div");
  line.className = "line";
  line.style.top = y + "px";
  canvas.appendChild(line);

  lines.push({ y });
}
for (let i = 0; i < 6; i++) addLine();

// ================= OUTILS =================
document.getElementById("toolPlace").onclick = () => tool = "place";
document.getElementById("toolSelect").onclick = () => tool = "select";
document.getElementById("toolDelete").onclick = () => tool = "delete";
document.getElementById("addLine").onclick = addLine;

// ================= PALETTE =================
const symbols = [
  "a","b","c","d","e","f","g","h","j","k",
  "/a","//a","///a",
  "1","2","3","4","5","6","7"
];

symbols.forEach(sym => {
  const el = document.createElement("div");
  el.className = "palette-item";
  el.textContent = sym;
  el.onclick = () => selectedSymbol = sym;
  palette.appendChild(el);
});

// ================= BARRE =================
document.getElementById("addBar").onclick = () => {
  const bar = document.createElement("div");
  bar.className = "bar";
  bar.style.left = "50%";
  bar.style.top = lines[0].y + "px";
  bar.style.height = (lines[lines.length-1].y - lines[0].y) + "px";

  bar.addEventListener("touchstart", e => {
    if (tool === "delete") bar.remove();
    selectedElement = bar;
    e.stopPropagation();
  }, { passive: false });

  bar.addEventListener("touchmove", e => {
    if (tool !== "select") return;
    bar.style.left = e.touches[0].clientX + "px";
  }, { passive: false });

  canvas.appendChild(bar);
};

// ================= PLACEMENT =================
canvas.addEventListener("touchstart", e => {
  if (tool !== "place" || !selectedSymbol) return;

  const rect = canvas.getBoundingClientRect();
  const yTouch = e.touches[0].clientY - rect.top;

  let closest = lines[0];
  let minDist = Math.abs(yTouch - closest.y);
  for (const l of lines) {
    const d = Math.abs(yTouch - l.y);
    if (d < minDist) {
      minDist = d;
      closest = l;
    }
  }

  const s = document.createElement("div");
  s.className = "symbol";
  s.textContent = selectedSymbol;
  s.style.left = (e.touches[0].clientX - rect.left) + "px";
  s.style.top = (closest.y + WRITE_OFFSET) + "px";

  s.addEventListener("touchstart", ev => {
    ev.stopPropagation();
    if (tool === "delete") {
      s.remove();
      return;
    }
    selectedElement = s;
  }, { passive: false });

  s.addEventListener("touchmove", ev => {
    if (tool !== "select") return;
    const r = canvas.getBoundingClientRect();
    s.style.left = (ev.touches[0].clientX - r.left) + "px";
  }, { passive: false });

  canvas.appendChild(s);
}, { passive: false });

</script>
</body>
</html>
