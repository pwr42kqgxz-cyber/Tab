<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Tablature baroque</title>

<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  height:100%;
  font-family:"IM Fell English", serif;
  overflow:hidden;
}

/* ===== TOOLBAR ===== */
#toolbar{
  position:fixed;
  top:0;
  left:0;
  right:0;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  padding:8px;
  border-bottom:1px solid black;
  z-index:10;
}

button{
  padding:10px 14px;
  border:1px solid black;
  background:white;
  font-size:15px;
}
button.active{
  background:black;
  color:white;
}

#bgColor{
  width:40px;
  height:40px;
  padding:0;
  border:1px solid black;
}

/* ===== CANVAS ===== */
#canvas-wrapper{
  position:absolute;
  top:70px;
  bottom:230px;
  left:0;
  right:0;
  overflow-y:auto;
}

#canvas{
  position:relative;
  min-height:2000px;
}

/* ===== LIGNES ===== */
.line{
  position:absolute;
  left:5%;
  right:5%;
  height:2px;
}
.line.black{ background:black; }
.line.white{ background:transparent; }

/* ===== SYMBOLES ===== */
.symbol{
  position:absolute;
  font-size:36px;
  line-height:1;
  white-space:nowrap;
}

/* ===== BARRES ===== */
.bar{
  position:absolute;
  width:8px;
  margin-left:-4px;
}
.bar::after{
  content:"";
  position:absolute;
  left:3px;
  top:0;
  bottom:0;
  width:2px;
  background:black;
}

/* ===== PALETTE ===== */
#palette{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:230px;
  border-top:1px solid black;
  padding:8px;
  display:flex;
  flex-wrap:wrap;
  align-items:flex-start;
}

.palette-item{
  border:1px solid black;
  padding:10px;
  margin:4px;
  font-size:30px;
  min-width:36px;
  text-align:center;
}

/* ===== CUSTOM SYMBOL ===== */
#customSymbolBox{
  display:flex;
  align-items:center;
  gap:6px;
  margin:4px;
}

#customSymbol{
  width:60px;
  font-size:28px;
  text-align:center;
}

/* ===== SCROLL ===== */
#scroll-buttons{
  position:fixed;
  right:10px;
  bottom:260px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

/* ===== PRINT ===== */
#print-area{
  padding-top:40px;
  background:white;
}
#print-title{
  text-align:center;
  font-size:36px;
  margin-bottom:40px;
}
</style>
</head>

<body>

<div id="toolbar">
  <button id="editTitle">‚úèÔ∏è Titre</button>
  <button id="toolPlace" class="active">‚úçÔ∏è Placer</button>
  <button id="toolSelect">üñê S√©lection</button>
  <button id="undo">‚Ü©Ô∏è Retour</button>
  <button id="deleteBtn">‚ùå Effacer</button>
  <button id="clearAllBtn">üóëÔ∏è Tout effacer</button>
  <button id="addBlackLine">‚ûï Ligne noire</button>
  <button id="addWhiteLine">‚ûï Ligne blanche</button>
  <button id="addBar">‚ûï Barre</button>
  <button id="toggleSnap" class="active">üß≤ Accroch√©</button>
  <input type="color" id="bgColor">
  <button id="exportPDF">üìÑ PDF</button>
</div>

<div id="canvas-wrapper">
  <div id="print-area">
    <div id="print-title"></div>
    <div id="canvas"></div>
  </div>
</div>

<div id="palette"></div>

<div id="scroll-buttons">
  <button id="scrollUp">‚¨ÜÔ∏è</button>
  <button id="scrollDown">‚¨áÔ∏è</button>
</div>

<script>
/* ===== ELEMENTS ===== */
const body=document.body;
const canvasWrapper=document.getElementById("canvas-wrapper");
const canvas=document.getElementById("canvas");
const palette=document.getElementById("palette");
const printTitle=document.getElementById("print-title");
const bgColor=document.getElementById("bgColor");

/* ===== BACKGROUND ===== */
function applyBg(c){
  body.style.background=c;
  canvasWrapper.style.background=c;
  canvas.style.background=c;
}
const savedBg=localStorage.getItem("bg_color");
if(savedBg){ bgColor.value=savedBg; applyBg(savedBg); }
bgColor.oninput=()=>{ applyBg(bgColor.value); localStorage.setItem("bg_color",bgColor.value); };

/* ===== TITLE ===== */
editTitle.onclick=()=>{
  const t=prompt("Titre du morceau :",printTitle.textContent||"");
  if(t!==null){ printTitle.textContent=t.trim(); saveState(); }
};

/* ===== STATE ===== */
let tool="place";
let snap=true;
let placingBar=false;
let active=null;
let selectedElement=null;
let history=[];
let currentY=40;
const LINE_SPACING=30;
const lines=[];

/* ===== TOOLS ===== */
toolPlace.onclick=()=>setTool("place");
toolSelect.onclick=()=>setTool("select");
toggleSnap.onclick=()=>{ snap=!snap; toggleSnap.classList.toggle("active",snap); };
function setTool(t){
  tool=t;
  toolPlace.classList.toggle("active",t==="place");
  toolSelect.classList.toggle("active",t==="select");
}

/* ===== UNDO / DELETE / CLEAR ===== */
undo.onclick=()=>{ const el=history.pop(); if(el){ el.remove(); saveState(); } };
deleteBtn.onclick=()=>{ if(selectedElement){ selectedElement.remove(); selectedElement=null; saveState(); } };
clearAllBtn.onclick=()=>{
  if(!confirm("Tout effacer ?")) return;
  canvas.innerHTML="";
  localStorage.removeItem("tablature_state");
  lines.length=0;
  history.length=0;
  currentY=40;
  createInitialStructure();
  saveState();
};

/* ===== SCROLL ===== */
scrollUp.onclick=()=>canvasWrapper.scrollBy({top:-200,behavior:"smooth"});
scrollDown.onclick=()=>canvasWrapper.scrollBy({top:200,behavior:"smooth"});

/* ===== LINES ===== */
function addLine(type){
  const l=document.createElement("div");
  l.className="line "+type;
  l.style.top=currentY+"px";
  canvas.appendChild(l);
  history.push(l);
  lines.push(currentY);
  currentY+=LINE_SPACING;
  saveState();
}
addBlackLine.onclick=()=>addLine("black");
addWhiteLine.onclick=()=>addLine("white");

function createInitialStructure(){
  for(let b=0;b<4;b++){
    for(let i=0;i<6;i++) addLine("black");
    if(b<3) addLine("white");
  }
}

/* ===== PALETTE ===== */
let selected="a";
const symbols=[
 "a","b","c","d","e","f","g","h","j","k",
 "/a","//a","///a","1","2","3","4","5","6","7"
];

symbols.forEach(s=>{
  const p=document.createElement("div");
  p.className="palette-item";
  p.textContent=s;
  p.onclick=()=>selected=s;
  palette.appendChild(p);
});

/* ===== CUSTOM SYMBOL INPUT ===== */
const customBox=document.createElement("div");
customBox.id="customSymbolBox";

const customInput=document.createElement("input");
customInput.id="customSymbol";
customInput.placeholder="‚ú±";

const customBtn=document.createElement("button");
customBtn.textContent="OK";

customBtn.onclick=()=>{
  if(customInput.value.trim()){
    selected=customInput.value.trim();
    customInput.value="";
  }
};

customBox.appendChild(customInput);
customBox.appendChild(customBtn);
palette.appendChild(customBox);

/* ===== BAR ===== */
addBar.onclick=()=>{ placingBar=true; setTool("select"); };

/* ===== SNAP ===== */
function snapY(rawY,symbol){
  const base=nearestLine(rawY);
  if(!snap) return rawY;
  if(symbol.startsWith("///")) return base+18;
  if(symbol.startsWith("//"))  return base+14;
  if(symbol.startsWith("/"))   return base+10;
  return base-16;
}

/* ===== INTERACTION ===== */
canvas.addEventListener("touchstart",e=>{
  const r=canvas.getBoundingClientRect();
  const x=e.touches[0].clientX-r.left;
  const y=e.touches[0].clientY-r.top;

  if(placingBar){
    placingBar=false;
    const b=document.createElement("div");
    b.className="bar";
    b.style.left=x+"px";
    b.style.top=y+"px";
    b.style.height="160px";
    canvas.appendChild(b);
    history.push(b);
    makeDraggable(b);
    saveState();
    return;
  }

  if(tool==="place"){
    const s=document.createElement("div");
    s.className="symbol";
    s.textContent=selected;
    s.style.left=x+"px";
    s.style.top=snapY(y,selected)+"px";
    canvas.appendChild(s);
    history.push(s);
    makeDraggable(s);
    saveState();
  }
},{passive:false});

/* ===== DRAG ===== */
function makeDraggable(el){
  el.addEventListener("touchstart",e=>{
    if(tool!=="select") return;
    active=el;
    selectedElement=el;
    e.stopPropagation();
  },{passive:false});

  el.addEventListener("touchmove",e=>{
    if(!active) return;
    const r=canvas.getBoundingClientRect();
    const x=e.touches[0].clientX-r.left;
    const y=e.touches[0].clientY-r.top;
    active.style.left=x+"px";
    active.style.top=el.classList.contains("symbol")?snapY(y,el.textContent)+"px":y+"px";
    e.preventDefault();
  },{passive:false});

  el.addEventListener("touchend",()=>{ active=null; saveState(); });
}

/* ===== UTILS ===== */
function nearestLine(y){
  return lines.reduce((a,b)=>Math.abs(b-y)<Math.abs(a-y)?b:a);
}

/* ===== SAVE / RESTORE ===== */
function saveState(){
  const state={
    title:printTitle.textContent,
    bg:bgColor.value,
    elements:Array.from(canvas.children).map(el=>({
      class:el.className,
      text:el.textContent||"",
      left:el.style.left,
      top:el.style.top,
      height:el.style.height||""
    }))
  };
  localStorage.setItem("tablature_state",JSON.stringify(state));
}

function restoreState(){
  const raw=localStorage.getItem("tablature_state");
  if(!raw){ createInitialStructure(); return; }
  const s=JSON.parse(raw);
  printTitle.textContent=s.title||"";
  if(s.bg){ bgColor.value=s.bg; applyBg(s.bg); }

  canvas.innerHTML="";
  lines.length=0;
  currentY=40;

  s.elements.forEach(e=>{
    const el=document.createElement("div");
    el.className=e.class;
    el.textContent=e.text;
    el.style.left=e.left;
    el.style.top=e.top;
    if(e.height) el.style.height=e.height;
    canvas.appendChild(el);

    if(el.classList.contains("line")){
      lines.push(parseFloat(e.top));
      currentY=parseFloat(e.top)+LINE_SPACING;
    }
    if(el.classList.contains("symbol")||el.classList.contains("bar")){
      makeDraggable(el);
    }
  });
}
restoreState();

/* ===== PDF ===== */
exportPDF.onclick=async()=>{
  saveState();
  toolbar.style.display="none";
  palette.style.display="none";
  scrollButtons.style.display="none";

  await new Promise(r=>setTimeout(r,100));

  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF("p","mm","a4");
  const img=await html2canvas(document.getElementById("print-area"),{scale:2});

  const w=210;
  const h=img.height*w/img.width;
  pdf.addImage(img.toDataURL("image/png"),"PNG",0,0,w,h);
  pdf.save("tablature.pdf");

  toolbar.style.display="";
  palette.style.display="";
  scrollButtons.style.display="";
};
</script>

</body>
</html>
