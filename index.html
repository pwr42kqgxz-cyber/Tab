<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Tablature baroque</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  font-family: serif;
  background: white;
  touch-action: none;
}

#toolbar {
  display: flex;
  gap: 8px;
  padding: 6px;
  border-bottom: 1px solid black;
}

button {
  font-size: 14px;
  padding: 6px 10px;
  border: 1px solid black;
  background: white;
  color: black;
}

button.active {
  background: black;
  color: white;
}

#canvas {
  position: relative;
  height: 65vh;
}

.line {
  position: absolute;
  left: 5%;
  right: 5%;
  height: 2px;
}

.line.black {
  background: black;
}

.line.white {
  background: #f0f0f0; /* visible mais discret */
}

.symbol {
  position: absolute;
  font-size: 22px;
  user-select: none;
  white-space: nowrap;
  touch-action: none;
}

#palette {
  height: 35vh;
  border-top: 1px solid black;
  padding: 8px;
  display: flex;
  flex-wrap: wrap;
}

.palette-item {
  border: 1px solid black;
  padding: 6px;
  margin: 4px;
  font-size: 18px;
}
</style>
</head>

<body>

<div id="toolbar">
  <button id="toolPlace" class="active">‚úçÔ∏è Placer</button>
  <button id="toolSelect">üñê S√©lection</button>
  <button id="undo">‚Ü©Ô∏é Retour</button>
  <button id="addBlack">‚ûï Ligne noire</button>
  <button id="addWhite">‚ûï Ligne blanche</button>
</div>

<div id="canvas"></div>
<div id="palette"></div>

<script>
// blocage scroll iOS
document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });

const canvas = document.getElementById("canvas");
const palette = document.getElementById("palette");

let tool = "place";
let selectedSymbol = null;

const LINE_SPACING = 40;
const history = [];
const lines = []; // { y, type, el }

// ===== outils =====
function setTool(t) {
  tool = t;
  document.getElementById("toolPlace").classList.toggle("active", t === "place");
  document.getElementById("toolSelect").classList.toggle("active", t === "select");
}
document.getElementById("toolPlace").onclick = () => setTool("place");
document.getElementById("toolSelect").onclick = () => setTool("select");

// ===== lignes =====
function addLine(type) {
  const y = 60 + lines.length * LINE_SPACING;
  const line = document.createElement("div");
  line.className = "line " + type;
  line.style.top = y + "px";
  canvas.appendChild(line);
  lines.push({ y, type, el: line });

  history.push(() => {
    canvas.removeChild(line);
    lines.pop();
  });
}

document.getElementById("addBlack").onclick = () => addLine("black");
document.getElementById("addWhite").onclick = () => addLine("white");

// ===== retour =====
document.getElementById("undo").onclick = () => {
  const action = history.pop();
  if (action) action();
};

// ===== palette =====
const symbols = [
  "a","b","c","d","e","f","g","h","j","k",
  "/a","//a","///a",
  "1","2","3","4","5","6","7",
  "|"
];

symbols.forEach(sym => {
  const el = document.createElement("div");
  el.className = "palette-item";
  el.textContent = sym;
  el.onclick = () => selectedSymbol = sym;
  palette.appendChild(el);
});

// ===== placement =====
canvas.addEventListener("touchstart", e => {
  if (tool !== "place" || !selectedSymbol) return;

  const rect = canvas.getBoundingClientRect();
  const x = e.touches[0].clientX - rect.left;
  const yTouch = e.touches[0].clientY - rect.top;

  const s = document.createElement("div");
  s.className = "symbol";
  s.textContent = selectedSymbol;
  s.style.left = x + "px";
  canvas.appendChild(s);

  requestAnimationFrame(() => {
    const h = s.offsetHeight || 22;

    if (selectedSymbol === "|") {
      // barre libre
      s.style.top = (yTouch - h / 2) + "px";
    } else {
      // aimantation sur la ligne NOIRE la plus proche
      const blackLines = lines.filter(l => l.type === "black");
      if (blackLines.length === 0) return;

      let closest = blackLines[0];
      let min = Math.abs(yTouch - closest.y);
      for (const l of blackLines) {
        const d = Math.abs(yTouch - l.y);
        if (d < min) {
          min = d;
          closest = l;
        }
      }
      s.style.top = (closest.y - h / 2) + "px";
    }
  });

  history.push(() => canvas.removeChild(s));

  s.addEventListener("touchmove", ev => {
    if (tool !== "select") return;
    const r = canvas.getBoundingClientRect();
    s.style.left = (ev.touches[0].clientX - r.left) + "px";
  }, { passive: false });

}, { passive: false });
</script>

</body>
</html>
