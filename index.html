<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Tablature baroque â€“ SVG</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English&display=swap" rel="stylesheet">

<style>
html,body{
  margin:0;
  padding:0;
  height:100%;
  font-family:"IM Fell English", serif;
  overflow:hidden;
  background:white;
}

/* ===== TOOLBAR ===== */
#toolbar{
  position:fixed;
  top:0;
  left:0;
  right:0;
  display:flex;
  gap:6px;
  padding:6px;
  border-bottom:1px solid black;
  background:white;
  z-index:10;
}

button{
  padding:8px 12px;
  border:1px solid black;
  background:white;
  font-size:14px;
}

button.active{
  background:black;
  color:white;
}

/* ===== CANVAS ===== */
#canvas-wrapper{
  position:absolute;
  top:50px;
  bottom:110px;
  left:0;
  right:0;
  overflow-y:auto;
}

#canvas{
  position:relative;
  min-height:1800px;
}

/* ===== TITLE ===== */
#print-title{
  text-align:center;
  font-size:34px;
  margin:40px 0 50px;
}

/* ===== LINES ===== */
.line{
  position:absolute;
  left:6%;
  right:6%;
  height:2px;
  background:black;
}

/* ===== SYMBOL ===== */
.symbol{
  position:absolute;
  font-size:34px;
  white-space:nowrap;
}

/* ===== BAR ===== */
.bar{
  position:absolute;
  width:2px;
  background:black;
}

/* ===== PALETTE ===== */
#palette{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:110px;
  border-top:1px solid black;
  display:flex;
  align-items:center;
  gap:4px;
  padding:6px;
  background:white;
}

.palette-item{
  border:1px solid black;
  padding:8px 10px;
  font-size:26px;
}
</style>
</head>

<body>

<div id="toolbar">
  <button id="exportSVG">SVG</button>
</div>

<div id="canvas-wrapper">
  <div id="print-title" contenteditable="true">Titre</div>
  <div id="canvas"></div>
</div>

<div id="palette"></div>

<script>
/* ================= PALETTE ================= */
let selected="a";
["a","b","c","d","e","f","g","h","j","k","/a","//a","///a"]
.forEach(s=>{
  const b=document.createElement("div");
  b.className="palette-item";
  b.textContent=s;
  b.onclick=()=>selected=s;
  palette.appendChild(b);
});

/* ================= STRUCTURE ================= */
let y=40;
const spacing=28;
const lines=[];

for(let b=0;b<4;b++){
  for(let i=0;i<6;i++) addLine();
  if(b<3) y+=spacing;
}

function addLine(){
  const l=document.createElement("div");
  l.className="line";
  l.style.top=y+"px";
  canvas.appendChild(l);
  lines.push(y);
  y+=spacing;
}

/* ================= SNAP ================= */
function snapY(raw){
  return lines.reduce((a,b)=>Math.abs(b-raw)<Math.abs(a-raw)?b:a)-16;
}

/* ================= PLACEMENT ================= */
canvas.addEventListener("click",e=>{
  const r=canvas.getBoundingClientRect();
  const s=document.createElement("div");
  s.className="symbol";
  s.textContent=selected;
  s.style.left=(e.clientX-r.left)+"px";
  s.style.top=snapY(e.clientY-r.top)+"px";
  canvas.appendChild(s);
});

/* ================= SVG EXPORT ================= */
exportSVG.onclick=()=>{
  const width=794;
  const height=1123;

  let svg=`<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">
  <style>
    text{font-family:'IM Fell English';font-size:34px;}
  </style>`;

  svg+=`<text x="${width/2}" y="60" text-anchor="middle">${print-title.textContent}</text>`;

  document.querySelectorAll(".line").forEach(l=>{
    const y=parseFloat(l.style.top);
    svg+=`<line x1="60" x2="${width-60}" y1="${y+100}" y2="${y+100}" stroke="black" stroke-width="2"/>`;
  });

  document.querySelectorAll(".symbol").forEach(s=>{
    svg+=`<text x="${parseFloat(s.style.left)+60}" y="${parseFloat(s.style.top)+110}">${s.textContent}</text>`;
  });

  svg+="</svg>";

  const blob=new Blob([svg],{type:"image/svg+xml"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="tablature.svg";
  a.click();
  URL.revokeObjectURL(url);
};
</script>

</body>
</html>
