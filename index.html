<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>Tablature baroque</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  height:100%;
  font-family:"IM Fell English", serif;
  overflow:hidden;
  background:white;
}

#toolbar{
  position:fixed;
  top:0;
  left:0;
  right:0;
  display:flex;
  gap:6px;
  padding:6px;
  border-bottom:1px solid black;
  background:white;
  z-index:10;
}

button{
  padding:8px 12px;
  border:1px solid black;
  background:white;
  font-size:14px;
}
button.active{
  background:black;
  color:white;
}

#canvas-wrapper{
  position:absolute;
  top:54px;
  bottom:120px;
  left:0;
  right:0;
  overflow-y:auto;
}

#canvas{
  position:relative;
  min-height:1800px;
}

#print-title{
  text-align:center;
  font-size:34px;
  margin:40px 0 50px;
}

.line{
  position:absolute;
  left:6%;
  right:6%;
  height:2px;
}
.line.black{background:black;}
.line.white{background:transparent;}

.symbol{
  position:absolute;
  font-size:34px;
  white-space:nowrap;
}

.bar{
  position:absolute;
  width:4px;
  background:black;
}

.selected{
  outline:2px solid black;
  background:rgba(0,0,0,0.05);
}

#palette{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:120px;
  border-top:1px solid black;
  background:white;
  display:flex;
  align-items:center;
  padding:6px;
  gap:4px;
  flex-wrap:wrap;
  z-index:10;
}

.palette-item{
  border:1px solid black;
  padding:8px 10px;
  font-size:26px;
  cursor:pointer;
}

#scroll-buttons{
  position:fixed;
  right:8px;
  bottom:130px;
  display:flex;
  flex-direction:column;
  gap:6px;
}

</style>
</head>

<body>

<div id="toolbar">
  <button id="toolPlace" class="active">Placer</button>
  <button id="toolSelect">SÃ©lection</button>
  <button id="undo">Retour</button>
  <button id="deleteBtn">Effacer</button>
  <button id="addBar">+ Barre</button>
</div>

<div id="canvas-wrapper">
  <div id="canvas"></div>
</div>

<div id="palette"></div>

<script>
const canvas=document.getElementById("canvas");
const palette=document.getElementById("palette");
const toolPlace=document.getElementById("toolPlace");
const toolSelect=document.getElementById("toolSelect");

let tool="place";
let selectedSymbol="a";
let selectedElement=null;
let currentY=40;
const LINE_SPACING=28;
const lines=[];
const history=[];

/* ===== TOOLS ===== */
function setTool(t){
  tool=t;
  toolPlace.classList.toggle("active",t==="place");
  toolSelect.classList.toggle("active",t==="select");
}
toolPlace.onclick=()=>setTool("place");
toolSelect.onclick=()=>setTool("select");

/* ===== STRUCTURE INIT ===== */
function createInitialStructure(){
  for(let r=0;r<4;r++){
    for(let i=0;i<3;i++) addLine("white");
    for(let i=0;i<6;i++) addLine("black");
  }
}

function addLine(type){
  const l=document.createElement("div");
  l.className="line "+type;
  l.style.top=currentY+"px";
  canvas.appendChild(l);
  if(type==="black") lines.push(currentY);
  currentY+=LINE_SPACING;
}

/* ===== PALETTE ===== */
[
 "a","b","c","d","e","f","g","h","j","k","l","m","n",
 "/a","//a","///a",
 ",",".",";","(",")","~","|"
].forEach(s=>{
  const p=document.createElement("div");
  p.className="palette-item";
  p.textContent=s;
  p.onclick=()=>{
    selectedSymbol=s;
    setTool("place");
  };
  palette.appendChild(p);
});

/* ===== SNAP ===== */
function nearestLine(y){
  return lines.reduce((a,b)=>Math.abs(b-y)<Math.abs(a-y)?b:a);
}

/* ===== BAR ===== */
document.getElementById("addBar").onclick=()=>{
  setTool("place");
  selectedSymbol="__BAR__";
};

/* ===== INTERACTION ===== */
canvas.addEventListener("click",e=>{
  const r=canvas.getBoundingClientRect();
  const x=e.clientX-r.left;
  const y=e.clientY-r.top;

  if(tool==="place"){
    if(selectedSymbol==="__BAR__"){
      const top=nearestLine(y);
      const b=document.createElement("div");
      b.className="bar";
      b.style.left=x+"px";
      b.style.top=top+"px";
      b.style.height=(6*LINE_SPACING)+"px";
      canvas.appendChild(b);
      makeSelectable(b);
    }else{
      const s=document.createElement("div");
      s.className="symbol";
      s.textContent=selectedSymbol;
      s.style.left=x+"px";
      s.style.top=(nearestLine(y)-16)+"px";
      canvas.appendChild(s);
      makeSelectable(s);
    }
  }
});

/* ===== SELECTION ===== */
function makeSelectable(el){
  el.onclick=e=>{
    if(tool!=="select") return;
    if(selectedElement) selectedElement.classList.remove("selected");
    selectedElement=el;
    el.classList.add("selected");
    e.stopPropagation();
  };
}

document.body.onclick=()=>{
  if(selectedElement){
    selectedElement.classList.remove("selected");
    selectedElement=null;
  }
};

/* ===== INIT ===== */
createInitialStructure();
</script>

</body>
</html>
