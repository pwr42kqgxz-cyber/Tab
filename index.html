<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Tablature baroque</title>

<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English&display=swap" rel="stylesheet">

<style>
*{ touch-action: manipulation; box-sizing:border-box; }

html,body{
  margin:0; padding:0; height:100%;
  font-family:"IM Fell English", serif;
  background:white; overflow:hidden;
}

/* ===== TOOLBAR ===== */
#toolbar{
  position:fixed; top:0; left:0; right:0;
  display:flex; gap:6px; padding:6px;
  border-bottom:1px solid black; background:white; z-index:10;
}
button{ padding:8px 12px; border:1px solid black; background:white; font-size:14px; }
button.active{ background:black; color:white; }
#bgColor{ width:34px; height:34px; border:1px solid black; }

/* ===== CANVAS ===== */
#canvas-wrapper{
  position:absolute; top:54px; bottom:120px; left:0; right:0;
  overflow:auto; background:white;
}
.page{
  position:relative;
  width:794px;            /* A4 largeur */
  min-height:1123px;      /* A4 hauteur */
  margin:0 auto 40px auto;
  background:white;
}
#print-title{
  text-align:center;
  font-size:34px;
  margin:36px 0 18px;     /* titre un peu plus bas */
}

/* ===== LINES ===== */
.line{
  position:absolute;
  left:0; right:0;        /* pleine largeur du canvas */
  height:2px;
}
.line.black{ background:black; }
.line.white{ background:transparent; }

/* ===== SYMBOLS ===== */
.symbol{
  position:absolute;
  font-size:34px;
  line-height:1;
  transform:translateY(-0.88em);
}

/* ===== DRAW ===== */
.draw{ position:absolute; }
.draw path{
  fill:none; stroke:black; stroke-width:2;
  stroke-linecap:round; stroke-linejoin:round;
}
.draw.selected{ outline:2px dashed black; }

/* ===== BAR ===== */
.bar{ position:absolute; width:4px; background:black; }
.bar::before{
  content:""; position:absolute; left:-12px; right:-12px; top:0; bottom:0;
}

/* ===== SELECTION ===== */
.selected{ outline:2px solid black; background:rgba(0,0,0,0.05); }

/* ===== PALETTE ===== */
#palette{
  position:fixed; bottom:0; left:0; right:0; height:120px;
  border-top:1px solid black; background:white; display:flex;
  align-items:center; padding:6px; gap:4px; z-index:10; flex-wrap:wrap;
}
.palette-item{
  border:1px solid black; padding:8px 10px; font-size:26px; cursor:pointer;
}
.palette-item.active{ background:black; color:white; }
#customChar{
  margin-left:auto; width:60px; font-size:26px; text-align:center;
  border:1px solid black;
}

/* ===== SCROLL + LOCK ===== */
#scroll-buttons{
  position:fixed; right:8px; bottom:130px; display:flex;
  flex-direction:column; gap:6px; z-index:10;
}
</style>
</head>

<body>

<div id="toolbar">
  <button id="editTitle">Titre</button>
  <button id="toolPlace" class="active">Placer</button>
  <button id="toolSelect">S√©lection</button>
  <button id="undo">Retour</button>
  <button id="deleteBtn">Effacer</button>
  <button id="clearAllBtn">Tout effacer</button>
  <button id="addBlackLine">+ Ligne noire</button>
  <button id="addWhiteLine">+ Ligne blanche</button>
  <button id="addBar">+ Barre</button>
  <button id="toggleSnap" class="active">Accroch√©</button>
  <input type="color" id="bgColor">
  <button id="toggleUI">üëÅ</button>
  <button id="page1" class="active">Page 1</button>
  <button id="page2">Page 2</button>
  <button id="page3">Page 3</button>
</div>

<div id="canvas-wrapper">
  <!-- pages inject√©es ici -->
</div>

<div id="palette"></div>

<div id="scroll-buttons">
  <button id="scrollUp">‚¨Ü</button>
  <button id="scrollDown">‚¨á</button>
  <button id="lockBtn">üîí</button>
</div>

<button id="showUIBtn" style="display:none; position:fixed; left:6px; top:6px;">‚¨ÖÔ∏é</button>

<script>
/* ================= DOM ================= */
const toolbar = document.getElementById("toolbar");
const palette = document.getElementById("palette");
const scrollButtons = document.getElementById("scroll-buttons");
const showUIBtn = document.getElementById("showUIBtn");
const toggleUI = document.getElementById("toggleUI");
const canvasWrapper = document.getElementById("canvas-wrapper");
const bgColor = document.getElementById("bgColor");

const toolPlace = document.getElementById("toolPlace");
const toolSelect = document.getElementById("toolSelect");
const undoBtn = document.getElementById("undo");
const deleteBtn = document.getElementById("deleteBtn");
const clearAllBtn = document.getElementById("clearAllBtn");
const addBlackLine = document.getElementById("addBlackLine");
const addWhiteLine = document.getElementById("addWhiteLine");
const addBar = document.getElementById("addBar");
const toggleSnap = document.getElementById("toggleSnap");
const editTitle = document.getElementById("editTitle");
const lockBtn = document.getElementById("lockBtn");

const pageBtns = {
  1: document.getElementById("page1"),
  2: document.getElementById("page2"),
  3: document.getElementById("page3")
};

/* ================= UI VISIBILITY ================= */
toggleUI.onclick=()=>{
  toolbar.style.display="none";
  palette.style.display="none";
  scrollButtons.style.display="none";
  showUIBtn.style.display="block";
};
showUIBtn.onclick=()=>{
  toolbar.style.display="";
  palette.style.display="";
  scrollButtons.style.display="";
  showUIBtn.style.display="none";
};

/* ================= BACKGROUND ================= */
function applyBg(c){
  document.body.style.background=c;
  canvasWrapper.style.background=c;
}
const savedBg = localStorage.getItem("bg_color");
if(savedBg){ bgColor.value=savedBg; applyBg(savedBg); }
bgColor.oninput=()=>{
  applyBg(bgColor.value);
  localStorage.setItem("bg_color",bgColor.value);
};

/* ================= STATE ================= */
let tool="place", snap=true, placingBar=false;
let selected="a", selectedElement=null, active=null;
let locked=false;

/* ===== DRAW STATE ===== */
let drawing=false, currentPath=null, drawStart={x:0,y:0};
const DRAW_W=80, DRAW_H=60;

/* ===== MUSIC GRID ===== */
const LINE_SPACING=28;

/* ===== PAGES ===== */
let currentPage=1;
const pages={}; // pageNumber -> { el, title, undo, y, lines }

/* ================= LOCK ================= */
function setLock(v){
  locked=v;
  lockBtn.classList.toggle("active",locked);
  canvasWrapper.style.overflowY = locked ? "hidden" : "auto";
}
lockBtn.onclick=()=>setLock(!locked);

/* ================= UNDO ================= */
const MAX_UNDO=40;
function pushUndo(){
  const p=pages[currentPage];
  p.undo.push(serializeState());
  if(p.undo.length>MAX_UNDO) p.undo.shift();
}
undoBtn.onclick=()=>{
  const p=pages[currentPage];
  if(!p.undo.length) return;
  restoreState(p.undo.pop(), false);
};

/* ================= SERIALIZE ================= */
function serializeState(){
  const pageEl=pages[currentPage].el;
  return JSON.stringify({
    title: pages[currentPage].title.textContent,
    elements:[...pageEl.children].filter(n=>n!==pages[currentPage].title).map(el=>{
      if(el.classList.contains("draw")){
        return{ class:"draw", left:el.style.left, top:el.style.top, d:el.querySelector("path").getAttribute("d") };
      }
      return{ class:el.className, text:el.textContent||"", left:el.style.left, top:el.style.top, height:el.style.height||"" };
    })
  });
}
function restoreState(raw,save=true){
  const s=typeof raw==="string"?JSON.parse(raw):raw;
  const p=pages[currentPage];
  p.el.innerHTML="";
  p.el.appendChild(p.title);
  p.lines.length=0;
  p.y=40;

  p.title.textContent=s.title||"";

  s.elements.forEach(e=>{
    if(e.class==="draw"){
      const w=document.createElement("div");
      w.className="draw";
      w.style.left=e.left; w.style.top=e.top;
      const svg=document.createElementNS("http://www.w3.org/2000/svg","svg");
      svg.setAttribute("width",DRAW_W); svg.setAttribute("height",DRAW_H);
      const pa=document.createElementNS("http://www.w3.org/2000/svg","path");
      pa.setAttribute("d",e.d);
      svg.appendChild(pa); w.appendChild(svg);
      p.el.appendChild(w); makeDraggable(w); return;
    }
    const el=document.createElement("div");
    el.className=e.class; el.textContent=e.text;
    el.style.left=e.left; el.style.top=e.top;
    if(e.height) el.style.height=e.height;
    p.el.appendChild(el);
    if(el.classList.contains("line")){
      p.lines.push(parseFloat(e.top)); p.y=parseFloat(e.top)+LINE_SPACING;
    }
    if(el.classList.contains("symbol")||el.classList.contains("bar")) makeDraggable(el);
  });
}

/* ================= STRUCTURE ================= */
function addLine(type){
  const p=pages[currentPage];
  const l=document.createElement("div");
  l.className="line "+type;
  l.style.top=p.y+"px";
  p.el.appendChild(l);
  p.lines.push(p.y);
  p.y+=LINE_SPACING;
  if(p.y+200>p.el.offsetHeight) p.el.style.minHeight=(p.y+400)+"px";
}
function createInitialStructure(){
  // 1 blanche
  addLine("white");
  // 5 syst√®mes: 6 noires + (2 blanches entre)
  for(let r=0;r<5;r++){
    for(let i=0;i<6;i++) addLine("black");
    if(r<4) for(let i=0;i<2;i++) addLine("white");
  }
  // 1 blanche
  addLine("white");
}
addBlackLine.onclick=()=>{ pushUndo(); addLine("black"); };
addWhiteLine.onclick=()=>{ pushUndo(); addLine("white"); };

/* ================= SNAP ================= */
function nearestLine(y){
  const a=pages[currentPage].lines;
  return a.reduce((p,c)=>Math.abs(c-y)<Math.abs(p-y)?c:p);
}
function snapY(y){
  if(!snap||!pages[currentPage].lines.length) return y;
  return nearestLine(y)+LINE_SPACING/2;
}
toggleSnap.onclick=()=>{ snap=!snap; toggleSnap.classList.toggle("active",snap); };

/* ================= INTERACTION ================= */
function pageRect(){ return pages[currentPage].el.getBoundingClientRect(); }

pages[1]=createPage(1); pages[2]=createPage(2); pages[3]=createPage(3);
switchPage(1);

function createPage(n){
  const el=document.createElement("div");
  el.className="page"; el.style.display="none";
  const title=document.createElement("div");
  title.id="print-title"; title.textContent="";
  el.appendChild(title);
  canvasWrapper.appendChild(el);
  return { el, title, y:40, lines:[], undo:[] };
}
function switchPage(n){
  pages[currentPage].el.style.display="none";
  currentPage=n;
  pages[currentPage].el.style.display="block";
  Object.values(pageBtns).forEach(b=>b.classList.remove("active"));
  pageBtns[n].classList.add("active");
}
pageBtns[1].onclick=()=>switchPage(1);
pageBtns[2].onclick=()=>switchPage(2);
pageBtns[3].onclick=()=>switchPage(3);

function initPages(){
  // page 1
  switchPage(1);
  createInitialStructure();
  // pages 2 & 3 vierges mais m√™me titre
  for(let i=2;i<=3;i++){
    switchPage(i);
    pages[i].title.textContent=pages[1].title.textContent;
    createInitialStructure();
  }
  switchPage(1);
}

/* ================= TITLE ================= */
editTitle.onclick=()=>{
  const t=prompt("Titre du morceau :", pages[currentPage].title.textContent||"");
  if(t===null) return;
  pushUndo();
  pages[currentPage].title.textContent=t.trim();
  for(let i=1;i<=3;i++) pages[i].title.textContent=t.trim();
};

/* ================= DRAG ================= */
function makeDraggable(el){
  el.addEventListener("touchstart",e=>{
    if(tool!=="select" && !el.classList.contains("draw")) return;
    pushUndo();
    if(selectedElement) selectedElement.classList.remove("selected");
    selectedElement=el; el.classList.add("selected"); active=el;
    e.stopPropagation();
  },{passive:false});
  el.addEventListener("touchmove",e=>{
    if(!active) return; e.preventDefault();
    const r=pageRect();
    const x=e.touches[0].clientX-r.left;
    const y=e.touches[0].clientY-r.top;
    active.style.left=x+"px"; active.style.top=y+"px";
  },{passive:false});
  el.addEventListener("touchend",()=>{ active=null; });
}

/* ================= CANVAS EVENTS ================= */
canvas.addEventListener("touchstart", e => {
  // IMPORTANT : ne rien faire si on est en mode s√©lection
  if (tool === "select") return;

  const r = canvas.getBoundingClientRect();
  const rawX = e.touches[0].clientX - r.left;
  const rawY = e.touches[0].clientY - r.top;

  const x = rawX / currentScale;
  const y = rawY / currentScale;

  pushUndo();

  /* ===== DESSIN ===== */
  if (selected === "__draw__") {
    setLock(true);
    drawing = true;
    drawStart = { x, y };

    const w = document.createElement("div");
    w.className = "draw selected";
    w.style.left = (x - DRAW_W / 2) + "px";
    w.style.top  = (y - DRAW_H / 2) + "px";

    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.setAttribute("width", DRAW_W);
    svg.setAttribute("height", DRAW_H);

    const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
    p.setAttribute("d", `M ${DRAW_W / 2} ${DRAW_H / 2}`);

    svg.appendChild(p);
    w.appendChild(svg);
    canvas.appendChild(w);

    currentPath = p;
    selectedElement = w;
    return;
  }

  /* ===== BARRE ===== */
  if (placingBar) {
    placingBar = false;

    const b = document.createElement("div");
    b.className = "bar";
    b.style.left = x + "px";
    b.style.top  = nearestLine(y) + "px";
    b.style.height = (5 * LINE_SPACING) + "px";

    canvas.appendChild(b);
    makeDraggable(b);
    saveState();
    return;
  }

  /* ===== SYMBOLE ===== */
  if (tool === "place" && selected) {
    const s = document.createElement("div");
    s.className = "symbol";
    s.textContent = selected;
    s.style.left = x + "px";
    s.style.top  = snapY(y) + "px";

    canvas.appendChild(s);
    makeDraggable(s);
    saveState();

    tool = null;
    toolPlace.classList.remove("active");
  }
}, { passive: false });

  if(placingBar){
    placingBar=false;
    const b=document.createElement("div");
    b.className="bar"; b.style.left=x+"px"; b.style.top=nearestLine(y)+"px";
    b.style.height=(5*LINE_SPACING)+"px";
    pages[currentPage].el.appendChild(b); makeDraggable(b); return;
  }

  if(tool==="place" && selected!=="__draw__"){
    const s=document.createElement("div");
    s.className="symbol"; s.textContent=selected;
    s.style.left=x+"px"; s.style.top=snapY(y)+"px";
    pages[currentPage].el.appendChild(s); makeDraggable(s);
    tool=null; toolPlace.classList.remove("active");
  }
},{passive:false});

document.addEventListener("touchmove",e=>{
  if(!drawing) return; e.preventDefault();
  const r=pageRect();
  const dx=e.touches[0].clientX-r.left-drawStart.x+DRAW_W/2;
  const dy=e.touches[0].clientY-r.top -drawStart.y+DRAW_H/2;
  const d=currentPath.getAttribute("d");
  currentPath.setAttribute("d", d+` L ${dx} ${dy}`);
},{passive:false});

document.addEventListener("touchend",()=>{
  drawing=false; currentPath=null;
  if(selectedElement && selected==="__draw__"){ selectedElement.classList.remove("selected"); selectedElement=null; }
  selected=null; tool=null; setLock(false);
});

/* ================= DELETE / CLEAR ================= */
deleteBtn.onclick=()=>{
  setTool("select");
  if(!selectedElement) return;
  pushUndo(); selectedElement.remove(); selectedElement=null;
};
clearAllBtn.onclick=()=>{
  if(!confirm("Effacer toute la tablature ?")) return;
  pushUndo();
  const p=pages[currentPage];
  p.el.innerHTML=""; p.el.appendChild(p.title);
  p.lines.length=0; p.y=40; createInitialStructure();
};

/* ================= BAR / SCROLL ================= */
addBar.onclick=()=>{ placingBar=true; setTool("place"); };
scrollUp.onclick=()=>canvasWrapper.scrollTop-=100;
scrollDown.onclick=()=>canvasWrapper.scrollTop+=100;

/* ================= PALETTE ================= */
[
 "a","b","c","d","e","f","g","h","j","k","l","m","n",
 "/a","//a","///a","4","5","6",",",".",":",";","(",")","[","]","~","‚åí","|","‚úé"
].forEach(s=>{
  const p=document.createElement("div");
  p.className="palette-item"; p.textContent=s;
  p.onclick=()=>{
    document.querySelectorAll(".palette-item").forEach(x=>x.classList.remove("active"));
    p.classList.add("active");
    selected=(s==="‚úé")?"__draw__":s; setTool("place");
    if(selected==="__draw__") setLock(true);
  };
  palette.appendChild(p);
});
const customInput=document.createElement("input");
customInput.id="customChar"; customInput.placeholder="‚ú±"; customInput.maxLength=3;
customInput.oninput=()=>{
  if(customInput.value.trim()!==""){
    selected=customInput.value.trim(); setTool("place"); setLock(false);
  }
};
palette.appendChild(customInput);

/* ================= INIT ================= */
function setTool(t){
  tool=t;
  toolPlace.classList.toggle("active",t==="place");
  toolSelect.classList.toggle("active",t==="select");
  if(t!=="place" || selected!=="__draw__") setLock(false);
}
initPages();
</script>
</body>
</html>
