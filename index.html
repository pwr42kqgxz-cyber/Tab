<!DOCTYPE html>
<html lang="fr" data-theme="classique">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Expires" content="0">
	<title>Tablature Luth Baroque</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

	<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;1,400&family=Tangerine:wght@700&display=swap" rel="stylesheet">

	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root {
	--bg-color: #ffffff;
	--text-color: #000000;
	--line-color: #000000;
	--ui-bg: #ffffff;
	--ui-border: #000000;
	--accent-color: #000000;
	--ui-text: #000000;
}

[data-theme="classique"] {
	--bg-color: #ffffff;
	--text-color: #000000;
	--line-color: #000000;
	--ui-bg: #ffffff;
	--ui-border: #000000;
	--accent-color: #000000;
	--ui-text: #000000;
}

[data-theme="moderne"] {
	--bg-color: #f5f5f5;
	--text-color: #1a1a1a;
	--line-color: #333333;
	--ui-bg: #e8e8e8;
	--ui-border: #666666;
	--accent-color: #4a90e2;
	--ui-text: #1a1a1a;
}

[data-theme="parchemin"] {
	--bg-color: #f4e8d0;
	--text-color: #3d2817;
	--line-color: #5d4730;
	--ui-bg: #ebe0c8;
	--ui-border: #8b7355;
	--accent-color: #8b4513;
	--ui-text: #3d2817;
}

[data-theme="nuit"] {
	--bg-color: #1a1a1a;
	--text-color: #e0e0e0;
	--line-color: #cccccc;
	--ui-bg: #2a2a2a;
	--ui-border: #555555;
	--accent-color: #6a9bd8;
	--ui-text: #e0e0e0;
}

* {
	touch-action: manipulation;
	-webkit-tap-highlight-color: transparent;
	box-sizing: border-box;
}

html, body {
	margin: 0;
	padding: 0;
	height: 100%;
	width: 100%;
	font-family: "EB Garamond", serif;
	overflow: hidden;
	background: var(--bg-color);
	color: var(--text-color);
}

/* ===== TOOLBAR ===== */
#toolbar {
	position: fixed;
	top: 8px;
	left: 50%;
	transform: translateX(-50%);
	width: calc(100% - 16px);
	max-width: 100%;
	display: flex;
	flex-wrap: wrap;
	gap: 6px;
	padding: 6px 8px;
	background: var(--ui-bg);
	border: 1px solid var(--ui-border);
	border-radius: 8px;
	box-shadow: 0 4px 12px rgba(0,0,0,0.15);
	z-index: 20;
}

.drag-handle {
	width: 80px;
	height: 20px;
	background: var(--ui-border);
	border-radius: 10px;
	cursor: grab;
	align-self: center;
	flex-shrink: 0;
	opacity: 0.4;
	position: relative;
}

.drag-handle::after {
	content: "‚ãÆ‚ãÆ‚ãÆ";
	position: absolute;
	left: 50%;
	top: 50%;
	transform: translate(-50%, -50%);
	color: var(--ui-bg);
	font-size: 16px;
	letter-spacing: 4px;
}

button {
	padding: 6px 10px;
	border: 1px solid var(--ui-border);
	background: var(--ui-bg);
	color: var(--ui-text);
	font-size: 14px;
	border-radius: 4px;
	-webkit-text-fill-color: var(--ui-text);
	appearance: none;
	-webkit-appearance: none;
}

button.active {
	background: var(--accent-color);
	color: white;
	-webkit-text-fill-color: white;
}

button.placing {
	background: var(--accent-color);
	color: white;
	-webkit-text-fill-color: white;
	animation: pulse 1s infinite;
}

@keyframes pulse {
	0%, 100% { opacity: 1; }
	50% { opacity: 0.6; }
}

#showUIBtn {
	position: fixed;
	right: 8px;
	top: 8px;
	z-index: 25;
	display: none;
}

/* ===== CANVAS ===== */
.symbol-wrapper {
	position: absolute;
	pointer-events: auto;
	z-index: 10;
}

#canvas {
	position: relative;
	width: 1100px;
	min-height: 1123px;
	margin: 0 auto;
	background: var(--bg-color);
	padding: 10px 20px;
}

/* ===== DRAW ===== */
.draw {
	position: absolute;
	pointer-events: auto;
}

.draw path {
	fill: none;
	stroke: var(--line-color);
	stroke-width: 2;
	stroke-linecap: round;
	stroke-linejoin: round;
	vector-effect: non-scaling-stroke;
}

/* ===== TITLE ===== */
#print-title {
	text-align: center;
	font-size: 32px;
	margin: 10px 0 20px;
	cursor: text;
	color: var(--text-color);
	font-family: 'EB Garamond', serif !important;
	font-style: normal !important;
	font-weight: 400;
}

/* ===== LINES ===== */
.line {
	position: absolute;
	left: 0;
	height: 1px;
	z-index: 1;
}

.line.black {
	background: var(--line-color);
}

.line.white {
	background: transparent;
}

/* ===== SYSTEM NUMBER ===== */
.system-number {
	position: absolute;
	left: -30px;
	font-size: 14px;
	color: var(--text-color);
	opacity: 0.5;
	pointer-events: none;
}

/* ===== SYMBOLS ===== */
.symbol {
	position: absolute;
	font-size: 40px;
	white-space: nowrap;
	line-height: normal;
	height: auto;
	overflow: visible;
	padding: 10px 0;
	margin-top: -10px;
	transform: translateX(-50%);
	color: var(--text-color);
	text-rendering: geometricPrecision;
	-webkit-font-smoothing: antialiased;
	z-index: 10;
	font-family: 'Tangerine', cursive !important;
	font-weight: 700 !important;
	font-style: normal !important;
}

.selected {
	text-shadow: 0 0 5px var(--accent-color);
	color: var(--accent-color);
}

/* ===== FLASH CONFIRMATION ===== */
@keyframes flash {
	0% { opacity: 0.2; }
	100% { opacity: 1; }
}

.flash {
	animation: flash 0.3s ease-out;
}

/* ===== BAR ===== */
.bar {
	position: absolute;
	width: 1px;
	background: var(--line-color);
	z-index: 2;
}

.system-bar {
	position: absolute;
	width: 1px;
	background: var(--line-color);
}

.system-bar.left { left: 0; }
.system-bar.right { right: 0; }

/* ===== POIGN√âE DE RACCOURCISSEMENT ===== */
.shorten-handle {
	position: absolute;
	width: 24px;
	height: 24px;
	background: var(--accent-color);
	border: 2px solid var(--line-color);
	border-radius: 50%;
	cursor: grab;
	z-index: 15;
	display: flex;
	align-items: center;
	justify-content: center;
	color: white;
	font-size: 12px;
	font-weight: bold;
	box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.shorten-handle::before {
	content: "‚ü∑";
}

.shorten-handle.dragging {
	cursor: grabbing;
	box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

/* ===== BARRE FINALE √âPAISSE ===== */
.end-bar {
	position: absolute;
	width: 3px;
	background: var(--line-color);
	z-index: 2;
}

/* ===== PALETTE ===== */
#palette {
	position: fixed;
	left: 50%;
	transform: translateX(-50%);
	width: calc(100% - 16px);
	max-width: 100%;
	bottom: 12px;
	padding: 6px 10px;
	display: flex;
	align-items: center;
	gap: 8px;
	background: var(--ui-bg);
	border: 1px solid var(--ui-border);
	border-radius: 8px;
	box-shadow: 0 4px 12px rgba(0,0,0,0.15);
	z-index: 30;
	flex-wrap: nowrap;
	overflow-x: auto;
	overflow-y: hidden;
	white-space: nowrap;
	-webkit-overflow-scrolling: touch;
}

.palette-item {
	flex: 0 0 auto;
	width: 36px;
	height: 36px;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 24px;
	line-height: 1;
	border: 1px solid var(--ui-border);
	background: var(--ui-bg);
	color: var(--ui-text);
	border-radius: 6px;
	padding: 0;
	cursor: pointer;
	font-family: 'Tangerine', cursive;
	font-weight: bold;
}

.palette-item.active {
	background: var(--accent-color);
	color: white;
}

#customChar {
	margin-left: auto;
	width: 60px;
	font-size: 22px;
	text-align: center;
	border: 1px solid var(--ui-border);
	background: var(--ui-bg);
	color: var(--ui-text);
}

/* ===== LOUPE ===== */
.drag-loupe {
	position: fixed;
	width: 120px;
	height: 120px;
	border-radius: 50%;
	overflow: hidden;
	pointer-events: none;
	z-index: 9999;
	background: var(--bg-color);
	border: 2px solid var(--line-color);
	box-shadow: 0 6px 16px rgba(0,0,0,0.3);
	transform: translate(-50%, -160%);
}

.drag-loupe canvas {
	width: 100%;
	height: 100%;
}

.loupe-cross {
	position: absolute;
	left: 50%;
	top: 50%;
	width: 24px;
	height: 24px;
	pointer-events: none;
	transform: translate(-50%, -50%);
}

.loupe-cross::before,
.loupe-cross::after {
	content: "";
	position: absolute;
	background: var(--line-color);
	opacity: 0.7;
}

.loupe-cross::before { left: 0; top: 50%; width: 100%; height: 1px; transform: translateY(-50%); }
.loupe-cross::after { top: 0; left: 50%; width: 1px; height: 100%; transform: translateX(-50%); }

.vertical-guide {
	position: absolute;
	top: 0; bottom: 0; width: 1px;
	background: var(--line-color);
	opacity: 0.15;
	pointer-events: none;
	z-index: 0;
}

/* ===== MODAL ===== */
.modal {
	display: none;
	position: fixed;
	inset: 0;
	background: rgba(0,0,0,0.5);
	z-index: 1000;
	align-items: center;
	justify-content: center;
}

.modal.active { display: flex; }

.modal-content {
	background: var(--ui-bg);
	border: 2px solid var(--ui-border);
	border-radius: 8px;
	padding: 20px;
	max-width: 90%;
	max-height: 80%;
	overflow: auto;
}

.modal-buttons {
	display: flex;
	gap: 10px;
	margin-top: 15px;
	justify-content: flex-end;
}

.page-btn {
	padding: 6px 10px;
	border: 1px solid var(--ui-border);
	background: var(--ui-bg);
	color: var(--ui-text);
	border-radius: 4px;
	font-size: 14px;
}

.page-btn.active {
	background: var(--accent-color);
	color: white;
	-webkit-text-fill-color: white;
}

/* ===== RESPONSIVE ===== */
@media screen and (orientation: landscape) {
	#toolbar { flex-wrap: nowrap; overflow-x: auto; }
	#canvas-wrapper { top: 60px; bottom: 70px; }
}
</style>
</head>
<body>
	<div id="toolbar">
		<div class="drag-handle" id="toolbarHandle"></div>
		<button id="editTitle">Titre</button>
		<button id="toolPlace" class="active">Placer</button>
		<button id="toolSelect">S√©lection</button>
		<button id="undo">Retour</button>
		<button id="deleteBtn">Effacer</button>
		<button id="clearAllBtn">Tout effacer</button>
		<button id="addBar">+ Barre</button>
		<button id="addEndBar">üéµ Raccourcir</button>
		<button id="addSystemBtn">+ Port√©e</button>
		<button id="toggleSnap" class="active">Accroch√©</button>
		<button id="themeBtn">Th√®me</button>
		<button id="saveBtn">üíæ</button>
		<button id="loadBtn">üìÇ</button>
		<button id="toggleUI">üëÅ</button>
		<div id="pageNav"></div>
		<button id="addPageBtn">+ Page</button>
		<button id="exportPDF">PDF</button>
		<button id="toggleVGuides">‚îÇ‚îÇ</button>
	</div>

	<div id="canvas-wrapper">
		<div id="print-title">Titre du Morceau</div>
		<div id="canvas"></div>
	</div>

	<div id="palette">
		<div class="drag-handle" id="paletteHandle"></div>
	</div>

	<button id="showUIBtn">‚¨ÖÔ∏é</button>

	<div id="themeModal" class="modal">
		<div class="modal-content">
			<h3>Choisir un th√®me</h3>
			<button onclick="applyTheme('classique')">Classique</button>
			<button onclick="applyTheme('moderne')">Moderne</button>
			<button onclick="applyTheme('parchemin')">Parchemin</button>
			<button onclick="applyTheme('nuit')">Nuit</button>
			<div class="modal-buttons">
				<button onclick="closeModal('themeModal')">Fermer</button>
			</div>
		</div>
	</div>

	<div id="exportModal" class="modal">
		<div class="modal-content">
			<h3>Options d'export PDF</h3>
			<label>
				<input type="checkbox" id="showSystemNumbers" checked>
				Afficher les num√©ros de syst√®mes
			</label>
			<div class="modal-buttons">
				<button onclick="closeModal('exportModal')">Annuler</button>
				<button onclick="confirmExport()">Exporter</button>
			</div>
		</div>
	</div>

<script>
const VERSION = "tablature-barok-v4";

/* ================= DOM ================= */
const toolbar = document.getElementById("toolbar");
const palette = document.getElementById("palette");
const showUIBtn = document.getElementById("showUIBtn");
const toggleUI = document.getElementById("toggleUI");
const canvasWrapper = document.getElementById("canvas-wrapper");
const canvas = document.getElementById("canvas");
const printTitle = document.getElementById("print-title");
const toolPlace = document.getElementById("toolPlace");
const toolSelect = document.getElementById("toolSelect");
const undoBtn = document.getElementById("undo");
const deleteBtn = document.getElementById("deleteBtn");
const clearAllBtn = document.getElementById("clearAllBtn");
const addBar = document.getElementById("addBar");
const addEndBar = document.getElementById("addEndBar");
const toggleSnap = document.getElementById("toggleSnap");
const editTitle = document.getElementById("editTitle");
const toggleVGuides = document.getElementById("toggleVGuides");
const addSystemBtn = document.getElementById("addSystemBtn");
const themeBtn = document.getElementById("themeBtn");
const saveBtn = document.getElementById("saveBtn");
const loadBtn = document.getElementById("loadBtn");
const addPageBtn = document.getElementById("addPageBtn");
const pageNav = document.getElementById("pageNav");

/* ================= STATE ================= */
let pageCount = 1;
let currentPage = 1;
const pages = {};
pages[1] = null;

let systemCount = 1;
const MAX_SYSTEMS = 7;
let showVerticalGuides = false;
let tool = "place";
let snap = true;
let placingBar = false;
let placingEndBar = false;
let selected = "a";
let selectedElement = null;
let active = null;

let dragLoupe = null;
let loupeCanvas = null;
let loupeCtx = null;
let loupeImage = null;

let currentY = 40;
const LINE_SPACING = 22;
const lines = [];

let drawing = false;
let currentPath = null;
let drawStart = { x: 0, y: 0 };
const DRAW_W = 120;
const DRAW_H = 100;

const undoStack = [];
const MAX_UNDO = 40;

const FIXED_FONT_SIZE = 40;
const SNAP_THRESHOLD = 15;

/* Stockage des syst√®mes et leurs limites de raccourcissement */
const systemEnds = {};

/* ================= HAPTIC FEEDBACK ================= */
function haptic() {
	if (navigator.vibrate) navigator.vibrate(10);
}

/* ================= THEME ================= */
function applyTheme(themeName) {
	document.documentElement.setAttribute("data-theme", themeName);
	localStorage.setItem("theme", themeName);
	closeModal("themeModal");
	haptic();
}

themeBtn.onclick = () => document.getElementById("themeModal").classList.add("active");

function closeModal(id) { document.getElementById(id).classList.remove("active"); }

document.addEventListener("click", e => {
	if (e.target.classList.contains("modal")) e.target.classList.remove("active");
});

/* ================= PAGE MANAGEMENT ================= */
function renderPageNav() {
	pageNav.innerHTML = "";
	for (let i = 1; i <= pageCount; i++) {
		const btn = document.createElement("button");
		btn.className = "page-btn";
		btn.textContent = "Page " + i;
		if (i === currentPage) btn.classList.add("active");
		btn.onclick = () => loadPage(i);
		pageNav.appendChild(btn);
	}
}

addPageBtn.onclick = () => {
	pageCount++;
	pages[pageCount] = null;
	loadPage(pageCount);
	renderPageNav();
	haptic();
};

function saveCurrentPage() {
	pages[currentPage] = serializeState();
}

function loadPage(n) {
	if (n === currentPage) return;
	saveCurrentPage();
	currentPage = n;
	if (pages[n]) {
		restoreState(pages[n], false);
	} else {
		const title = printTitle.textContent;
		canvas.innerHTML = "";
		lines.length = 0;
		currentY = 40;
		systemCount = 1;
		printTitle.textContent = title;
		createInitialStructure();
		saveCurrentPage();
	}
	renderPageNav();
	haptic();
}

/* ================= SAVE / LOAD ================= */
saveBtn.onclick = () => {
	saveCurrentPage();
	const data = {
		version: VERSION,
		created: new Date().toISOString(),
		title: printTitle.textContent,
		theme: document.documentElement.getAttribute("data-theme"),
		pageCount: pageCount,
		pages: pages
	};
	const json = JSON.stringify(data, null, 2);
	const blob = new Blob([json], { type: "application/json" });
	const url = URL.createObjectURL(blob);
	const a = document.createElement("a");
	a.href = url;
	a.download = `tablature-${Date.now()}.json`;
	a.click();
	URL.revokeObjectURL(url);
	haptic();
};

loadBtn.onclick = () => {
	const input = document.createElement("input");
	input.type = "file";
	input.accept = ".json";
	input.onchange = e => {
		const file = e.target.files[0];
		if (!file) return;
		const reader = new FileReader();
		reader.onload = event => {
			try {
				const data = JSON.parse(event.target.result);
				printTitle.textContent = data.title || "";
				if (data.theme) applyTheme(data.theme);
				pageCount = data.pageCount || 1;
				Object.assign(pages, data.pages);
				currentPage = 0;
				loadPage(1);
				renderPageNav();
				haptic();
				alert("Tablature charg√©e !");
			} catch (err) {
				alert("Erreur de chargement : fichier invalide");
			}
		};
		reader.readAsText(file);
	};
	input.click();
};

/* ================= UI VISIBILITY ================= */
toggleUI.onclick = () => {
	toolbar.style.display = "none";
	palette.style.display = "none";
	showUIBtn.style.display = "block";
};
showUIBtn.onclick = () => {
	toolbar.style.display = "";
	palette.style.display = "";
	showUIBtn.style.display = "none";
};

/* ================= UNDO ================= */
function serializeState() {
	return JSON.stringify({
		title: printTitle.textContent,
		theme: document.documentElement.getAttribute("data-theme"),
		systemCount: systemCount,
		systemEnds: systemEnds,
		elements: [...canvas.children].map(el => {
			if (el.classList.contains("draw")) {
				return {
					class: "draw", left: el.style.left, top: el.style.top,
					d: el.querySelector("path").getAttribute("d")
				};
			}
			return {
				class: el.className,
				text: el.textContent || "",
				left: el.style.left,
				top: el.style.top,
				height: el.style.height || "",
				width: el.style.width || "",
				right: el.style.right || "",
				systemId: el.dataset.systemId || ""
			};
		})
	});
}

function pushUndo() {
	undoStack.push(serializeState());
	if (undoStack.length > MAX_UNDO) undoStack.shift();
}

undoBtn.onclick = () => {
	if (!undoStack.length) return;
	restoreState(undoStack.pop(), false);
	haptic();
};

/* ================= PERSISTENCE ================= */
function saveState() {
	localStorage.setItem("tablature_state", serializeState());
}

function restoreState(raw, save = true) {
	const s = typeof raw === "string" ? JSON.parse(raw) : raw;
	canvas.innerHTML = "";
	lines.length = 0;
	currentY = 40;
	systemCount = s.systemCount || 1;
	printTitle.textContent = s.title || "Titre du Morceau";

	if (s.theme) applyTheme(s.theme);
	
	// Restaurer les limites des syst√®mes
	Object.assign(systemEnds, s.systemEnds || {});

	s.elements.forEach(e => {
		if (e.class === "draw") {
			const w = document.createElement("div");
			w.className = "draw";
			w.style.left = e.left; w.style.top = e.top;
			const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
			svg.setAttribute("width", DRAW_W); svg.setAttribute("height", DRAW_H);
			const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
			p.setAttribute("d", e.d);
			svg.appendChild(p);
			w.appendChild(svg);
			canvas.appendChild(w);
			makeDraggable(w);
			return;
		}

		const el = document.createElement("div");
		el.className = e.class;
		el.textContent = e.text;
		el.style.left = e.left;
		el.style.top = e.top;
		if (e.height) el.style.height = e.height;
		if (e.width) el.style.width = e.width;
		if (e.right) el.style.right = e.right;
		if (e.systemId) el.dataset.systemId = e.systemId;
		
		if (el.classList.contains("symbol")) {
			makeDraggable(el);
		}
		
		canvas.appendChild(el);

		if (el.classList.contains("line")) {
			lines.push(parseFloat(e.top));
			currentY = parseFloat(e.top) + LINE_SPACING;
		}
		
		if (el.classList.contains("bar") || el.classList.contains("end-bar")) {
			makeDraggable(el);
		}
		
		if (el.classList.contains("shorten-handle")) {
			makeShortenHandleDraggable(el);
		}
	});
	
	if (showVerticalGuides) renderVerticalGuides();
	if (save) saveState();
}

function restoreFromStorage() {
	const raw = localStorage.getItem("tablature_state");
	if (raw) restoreState(raw, false);
	else { createInitialStructure(); saveState(); }
}

/* ================= TITLE ================= */
editTitle.onclick = () => {
	const t = prompt("Titre du morceau :", printTitle.textContent || "");
	if (t === null) return;
	pushUndo();
	printTitle.textContent = t.trim();
	saveState();
	haptic();
};

/* ================= TOOLS ================= */
function setTool(t) {
	tool = t;
	toolPlace.classList.toggle("active", t === "place");
	toolSelect.classList.toggle("active", t === "select");
}

toolPlace.onclick = () => {
	if (tool === "place") { tool = null; toolPlace.classList.remove("active"); }
	else setTool("place");
	haptic();
};

toolSelect.onclick = () => {
	setTool("select");
	if (selectedElement) {
		selectedElement.classList.remove("selected");
		selectedElement = null;
	}
	haptic();
};

toggleSnap.onclick = () => {
	snap = !snap;
	toggleSnap.classList.toggle("active", snap);
	haptic();
};

toggleVGuides.onclick = () => {
	showVerticalGuides = !showVerticalGuides;
	toggleVGuides.classList.toggle("active", showVerticalGuides);
	renderVerticalGuides();
	haptic();
};

/* ================= STRUCTURE ================= */
function addLine(type, systemId = null) {
	const l = document.createElement("div");
	l.className = "line " + type;
	l.style.top = currentY + "px";
	if (systemId) {
		l.dataset.systemId = systemId;
		// Appliquer le raccourcissement si d√©fini
		if (systemEnds[systemId]) {
			l.style.right = systemEnds[systemId] + "px";
		} else {
			l.style.right = "0";
		}
	} else {
		l.style.right = "0";
	}
	canvas.appendChild(l);
	lines.push(currentY);
	currentY += LINE_SPACING;
	if (currentY + 100 > canvas.offsetHeight) canvas.style.minHeight = (currentY + 200) + "px";
}

function addSystemSideBars(startY, systemNum) {
	const systemId = `system-${systemNum}`;
	
	const leftBar = document.createElement("div");
	leftBar.className = "bar system-bar left";
	leftBar.style.top = startY + "px";
	leftBar.style.height = (5 * LINE_SPACING) + "px";
	leftBar.dataset.systemId = systemId;

	const rightBar = document.createElement("div");
	rightBar.className = "bar system-bar right";
	rightBar.style.top = startY + "px";
	rightBar.style.height = (5 * LINE_SPACING) + "px";
	rightBar.dataset.systemId = systemId;

	const numLabel = document.createElement("div");
	numLabel.className = "system-number";
	numLabel.textContent = systemNum;
	numLabel.style.top = startY + "px";

	canvas.appendChild(leftBar);
	canvas.appendChild(rightBar);
	canvas.appendChild(numLabel);
}

function createInitialStructure() {
	addLine("white");
	addLine("white");
	const systemTop = currentY;
	const systemId = `system-1`;
	for (let i = 0; i < 6; i++) addLine("black", systemId);
	addSystemSideBars(systemTop, 1);
	systemCount = 1;
}

addSystemBtn.onclick = () => {
	if (systemCount >= MAX_SYSTEMS) { alert(`Max ${MAX_SYSTEMS} port√©es`); return; }
	pushUndo();
	addLine("white");
	addLine("white");
	const systemTop = currentY;
	systemCount++;
	const systemId = `system-${systemCount}`;
	for (let i = 0; i < 6; i++) addLine("black", systemId);
	addSystemSideBars(systemTop, systemCount);
	if (systemCount === MAX_SYSTEMS) addLine("white");
	saveState();
	haptic();
};

/* ================= SNAP ================= */
function nearestLine(y) {
	return lines.reduce((a, b) => Math.abs(b - y) < Math.abs(a - y) ? b : a);
}
function snapY(y) { return (snap && lines.length) ? nearestLine(y) : y; }

function snapToNearbySymbols(x, y) {
	if (!snap) return x;
	const symbols = document.querySelectorAll(".symbol");
	let nearestX = null;
	let minDist = SNAP_THRESHOLD;
	symbols.forEach(sym => {
		const symY = parseFloat(sym.style.top);
		if (Math.abs(symY - y) < LINE_SPACING * 3) {
			const symX = parseFloat(sym.style.left);
			const dist = Math.abs(symX - x);
			if (dist < minDist) {
				minDist = dist;
				nearestX = symX;
			}
		}
	});
	return nearestX !== null ? nearestX : x;
}

function firstLineOfSystem(y) {
	const lineY = nearestLine(y);
	let idx = lines.indexOf(lineY);
	let count = 0;
	while (idx > 0 && count < 5) {
		const prevY = lines[idx - 1];
		if (!document.querySelector(`.line.black[style*="top: ${prevY}px"]`)) break;
		idx--;
		count++;
	}
	return lines[idx];
}

function getSystemIdAtY(y) {
	const lineY = nearestLine(y);
	const lineEl = document.querySelector(`.line.black[style*="top: ${lineY}px"]`);
	return lineEl ? lineEl.dataset.systemId : null;
}

function renderVerticalGuides() {
	document.querySelectorAll(".vertical-guide").forEach(g => g.remove());
	if (!showVerticalGuides) return;
	const step = 60;
	const width = canvas.offsetWidth;
	for (let x = step; x < width; x += step) {
		const g = document.createElement("div");
		g.className = "vertical-guide";
		g.style.left = x + "px";
		canvas.appendChild(g);
	}
}

/* ================= RACCOURCISSEMENT DE SYST√àME ================= */
function updateSystemEnd(systemId, rightOffset) {
	systemEnds[systemId] = rightOffset;
	
	// Mettre √† jour toutes les lignes du syst√®me
	const systemLines = document.querySelectorAll(`.line[data-system-id="${systemId}"]`);
	systemLines.forEach(line => {
		line.style.right = rightOffset + "px";
	});
	
	// Mettre √† jour la barre de droite
	const rightBar = document.querySelector(`.system-bar.right[data-system-id="${systemId}"]`);
	if (rightBar) {
		rightBar.style.right = rightOffset + "px";
	}
	
	// Mettre √† jour ou cr√©er la barre de fin
	let endBar = document.querySelector(`.end-bar[data-system-id="${systemId}"]`);
	if (!endBar) {
		const topLine = parseFloat(systemLines[0].style.top);
		endBar = document.createElement("div");
		endBar.className = "end-bar";
		endBar.dataset.systemId = systemId;
		endBar.style.top = topLine + "px";
		endBar.style.height = (5 * LINE_SPACING) + "px";
		canvas.appendChild(endBar);
	}
	endBar.style.right = rightOffset + "px";
}

function makeShortenHandleDraggable(handle) {
	let startX = 0;
	let startRight = 0;
	let isDragging = false;
	const systemId = handle.dataset.systemId;
	
	handle.addEventListener("touchstart", e => {
		e.preventDefault();
		e.stopPropagation();
		pushUndo();
		isDragging = true;
		handle.classList.add("dragging");
		startX = e.touches[0].clientX;
		startRight = parseFloat(handle.style.right) || 0;
		haptic();
	}, { passive: false });
	
	document.addEventListener("touchmove", e => {
		if (!isDragging) return;
		e.preventDefault();
		
		const deltaX = startX - e.touches[0].clientX;
		let newRight = Math.max(0, startRight + deltaX);
		
		// Limite √† la largeur du canvas
		const maxRight = canvas.offsetWidth - 50;
		newRight = Math.min(newRight, maxRight);
		
		handle.style.right = newRight + "px";
		updateSystemEnd(systemId, newRight);
	}, { passive: false });
	
	document.addEventListener("touchend", () => {
		if (!isDragging) return;
		isDragging = false;
		handle.classList.remove("dragging");
		saveState();
	});
}

/* ================= INTERACTION ================= */
function getCanvasCoords(touch) {
	const canvasRect = canvas.getBoundingClientRect();
	return {
		x: touch.clientX - canvasRect.left,
		y: touch.clientY - canvasRect.top
	};
}

/* ===== OFFSET TYPO CIBL√â ===== */
const LETTER_VERTICAL_OFFSET = {
	a: 2,
	c: 2,
	e: 2,
	n: 2,
	m: 2
};

/* ===== CORRECTION HORIZONTALE DES /a ===== */
const SLASH_X_OFFSET = {
	"/a": -6,
	"//a": -10,
	"///a": -14
};

/* ===== JITTER MANUSCRIT (POSE UNIQUEMENT) ===== */
function applyJitter(el) {
	const sizeJitter = (Math.random() * 0.8 - 0.4);
	const rotJitter  = (Math.random() * 0.6 - 0.3);

	el.style.fontSize = (FIXED_FONT_SIZE + sizeJitter) + "px";
	el.style.transform += ` rotate(${rotJitter}deg)`;
	el.dataset.jittered = "1";
}

function symbolVerticalOffset(char) {
	let base = FIXED_FONT_SIZE * 0.55;

	if (LETTER_VERTICAL_OFFSET[char]) {
		base += LETTER_VERTICAL_OFFSET[char];
	}

	return base;
}

canvas.addEventListener("touchstart", e => {
	if (tool === "select" && !e.target.closest(".symbol, .bar, .end-bar, .draw, .shorten-handle")) {
		if (selectedElement) {
			selectedElement.classList.remove("selected");
			selectedElement = null;
		}
	}

	const { x, y } = getCanvasCoords(e.touches[0]);
	pushUndo();

	/* ===== MODE DESSIN ===== */
	if (selected === "__draw__") {
		drawing = true;
		drawStart = { x, y };

		const w = document.createElement("div");
		w.className = "draw";
		w.style.left = (x - DRAW_W / 2) + "px";
		w.style.top  = (y - DRAW_H / 2) + "px";

		const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
		svg.setAttribute("width", DRAW_W);
		svg.setAttribute("height", DRAW_H);

		const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
		p.setAttribute("d", `M ${DRAW_W / 2} ${DRAW_H / 2}`);

		svg.appendChild(p);
		w.appendChild(svg);
		canvas.appendChild(w);

		currentPath = p;
		selectedElement = w;
		return;
	}

	/* ===== MODE RACCOURCIR ===== */
	if (placingEndBar) {
		placingEndBar = false;
		addEndBar.classList.remove("placing");

		const systemId = getSystemIdAtY(y);
		if (!systemId) {
			alert("Cliquez sur un syst√®me pour le raccourcir");
			return;
		}

		// V√©rifier si une poign√©e existe d√©j√†
		const existingHandle = document.querySelector(`.shorten-handle[data-system-id="${systemId}"]`);
		if (existingHandle) {
			alert("Ce syst√®me a d√©j√† une poign√©e de raccourcissement");
			return;
		}

		// Cr√©er la poign√©e
		const topLine = firstLineOfSystem(y);
		const handle = document.createElement("div");
		handle.className = "shorten-handle";
		handle.dataset.systemId = systemId;
		handle.style.top = (topLine + (5 * LINE_SPACING / 2) - 12) + "px";
		handle.style.right = "0px";
		
		canvas.appendChild(handle);
		makeShortenHandleDraggable(handle);
		updateSystemEnd(systemId, 0);
		
		saveState();
		haptic();
		return;
	}

	/* ===== MODE BARRE NORMALE ===== */
	if (placingBar) {
		placingBar = false;
		addBar.classList.remove("placing");

		const topLine = firstLineOfSystem(y);
		const b = document.createElement("div");
		b.className = "bar";
		b.style.left = x + "px";
		b.style.top  = topLine + "px";
		b.style.height = (5 * LINE_SPACING) + "px";

		canvas.appendChild(b);
		makeDraggable(b);
		saveState();
		haptic();
		return;
	}

	/* ===== POSE DE SYMBOLE ===== */
	if (tool === "place" && selected !== "__draw__") {
		const snappedY = snapY(y);
		const snappedX = snapToNearbySymbols(x, snappedY);

		const w = document.createElement("div");
		w.className = "symbol-wrapper";

		const offset = symbolVerticalOffset(selected);
		w.style.left = snappedX + "px";
		w.style.top  = (snappedY - offset) + "px";

		if (SLASH_X_OFFSET[selected]) {
			w.style.transform =
				`translateX(calc(-50% + ${SLASH_X_OFFSET[selected]}px))`;
		} else {
			w.style.transform = "translateX(-50%)";
		}

		const s = document.createElement("div");
		s.className = "symbol";
		s.textContent = selected;

		applyJitter(s);

		w.appendChild(s);
		canvas.appendChild(w);
		makeDraggable(w);

		s.classList.add("flash");
		setTimeout(() => s.classList.remove("flash"), 300);

		saveState();
		haptic();
	}
}, { passive: false });

canvas.addEventListener("touchmove", e => {
	if (!drawing) return;
	e.preventDefault();

	const { x, y } = getCanvasCoords(e.touches[0]);
	const dx = x - drawStart.x + DRAW_W / 2;
	const dy = y - drawStart.y + DRAW_H / 2;

	currentPath.setAttribute(
		"d",
		currentPath.getAttribute("d") + ` L ${dx} ${dy}`
	);
}, { passive: false });

canvas.addEventListener("touchend", () => {
	if (!drawing) return;

	drawing = false;
	currentPath = null;

	if (selectedElement) {
		makeDraggable(selectedElement);
		selectedElement = null;
	}

	selected = "a";
	tool = null;
	toolPlace.classList.remove("active");

	document
		.querySelectorAll(".palette-item")
		.forEach(item => item.classList.remove("active"));

	saveState();
});

/* ================= DRAG ================= */
function makeDraggable(el) {
	el.addEventListener("touchstart", async e => {
		if (tool !== "select") return;
		e.preventDefault();
		pushUndo();
		if (selectedElement && selectedElement !== el) selectedElement.classList.remove("selected");
		selectedElement = el;
		el.classList.add("selected");
		active = el;
		haptic();

		if (!dragLoupe) {
			dragLoupe = document.createElement("div");
			dragLoupe.className = "drag-loupe";
			loupeCanvas = document.createElement("canvas");
			loupeCanvas.width = 120; loupeCanvas.height = 120;
			loupeCtx = loupeCanvas.getContext("2d");
			dragLoupe.appendChild(loupeCanvas);
			document.body.appendChild(dragLoupe);
			const cross = document.createElement("div");
			cross.className = "loupe-cross";
			dragLoupe.appendChild(cross);
			
			const snap = await html2canvas(canvas, {
				backgroundColor: getComputedStyle(canvas).backgroundColor,
				scale: 2,
				logging: false
			});
			loupeImage = snap;
		}
	}, { passive: false });

	el.addEventListener("touchmove", e => {
		if (!active || !loupeImage) return;
		e.preventDefault();
		const t = e.touches[0];
		const { x, y } = getCanvasCoords(t);
		const snappedY = snapY(y);
		const snappedX = el.classList.contains("symbol") ? snapToNearbySymbols(x, snappedY) : x;

		if (active.classList.contains("symbol")) {
			const offset = symbolVerticalOffset();
			active.style.left = snappedX + "px";
			active.style.top  = (snappedY - offset) + "px";
		} else {
			active.style.left = snappedX + "px";
			active.style.top  = snappedY + "px";
		}

		dragLoupe.style.left = t.clientX + "px";
		dragLoupe.style.top  = t.clientY + "px";

		loupeCtx.clearRect(0, 0, 120, 120);
		loupeCtx.drawImage(loupeImage, (x * 2) - 50, (y * 2) - 50, 100, 100, 0, 0, 120, 120);
	}, { passive: false });

	el.addEventListener("touchend", () => {
		if (dragLoupe) { dragLoupe.remove(); dragLoupe = null; }
		active = null;
		saveState();
	});
}

/* ================= DELETE / CLEAR ================= */
deleteBtn.onclick = () => {
	setTool("select");
	if (!selectedElement) return;
	pushUndo();
	
	// Si on supprime une poign√©e, r√©tablir le syst√®me en entier
	if (selectedElement.classList.contains("shorten-handle")) {
		const systemId = selectedElement.dataset.systemId;
		delete systemEnds[systemId];
		
		// R√©tablir les lignes
		const systemLines = document.querySelectorAll(`.line[data-system-id="${systemId}"]`);
		systemLines.forEach(line => line.style.right = "0");
		
		// R√©tablir la barre de droite
		const rightBar = document.querySelector(`.system-bar.right[data-system-id="${systemId}"]`);
		if (rightBar) rightBar.style.right = "0";
		
		// Supprimer la barre de fin
		const endBar = document.querySelector(`.end-bar[data-system-id="${systemId}"]`);
		if (endBar) endBar.remove();
	}
	
	selectedElement.remove();
	selectedElement = null;
	saveState();
	haptic();
};

clearAllBtn.onclick = () => {
	if (!confirm("Effacer toute la tablature ?")) return;
	pushUndo();
	canvas.innerHTML = "";
	lines.length = 0;
	currentY = 40;
	systemCount = 1;
	Object.keys(systemEnds).forEach(key => delete systemEnds[key]);
	createInitialStructure();
	saveState();
	haptic();
};

addBar.onclick = () => {
	placingBar = true;
	placingEndBar = false;
	addBar.classList.add("placing");
	addEndBar.classList.remove("placing");
	setTool("place");
	haptic();
};

addEndBar.onclick = () => {
	placingEndBar = true;
	placingBar = false;
	addEndBar.classList.add("placing");
	addBar.classList.remove("placing");
	setTool("place");
	haptic();
};

/* ================= PALETTE ================= */
[
	"a","b","c","d","e","f","g","h","j","k",
	"l","m","n",
	"/a","//a","///a","4","5","6",
	",",".","‚åí","‚å£","|","‚úé"
].forEach(s => {
	const p = document.createElement("div");
	p.className = "palette-item";
	p.textContent = s;

	p.onclick = () => {
		document.querySelectorAll(".palette-item").forEach(item => item.classList.remove("active"));
		p.classList.add("active");
		selected = (s === "‚úé") ? "__draw__" : s;
		setTool("place");
		haptic();
	};
	palette.appendChild(p);
});

const customInput = document.createElement("input");
customInput.id = "customChar";
customInput.placeholder = "‚ú±";
customInput.maxLength = 3;
customInput.oninput = () => {
	if (customInput.value.trim() !== "") {
		selected = customInput.value.trim();
		setTool("place");
	}
};
palette.appendChild(customInput);

/* ================= EXPORT PDF ================= */
document.getElementById("exportPDF").onclick = () => document.getElementById("exportModal").classList.add("active");

async function confirmExport() {
	const showNumbers = document.getElementById("showSystemNumbers").checked;
	if (!showNumbers) document.querySelectorAll(".system-number").forEach(n => n.style.display = "none");
	
	// Cacher les poign√©es pour l'export
	document.querySelectorAll(".shorten-handle").forEach(h => h.style.display = "none");
	
	closeModal("exportModal");
	saveCurrentPage();
	const originalPage = currentPage;
	const ui = [toolbar, palette];
	ui.forEach(el => el.style.display = "none");
	await new Promise(r => requestAnimationFrame(r));

	const pdf = new jspdf.jsPDF("p", "mm", "a4");
	const pageWidth = 210;
	const y = 15;

	const capture = async (pageNum, addPage) => {
		if (!pages[pageNum]) return;
		loadPage(pageNum);
		await new Promise(r => setTimeout(r, 150));
		const exportWrapper = document.createElement("div");
		exportWrapper.style.background = getComputedStyle(document.body).backgroundColor;
		exportWrapper.style.padding = "20px 24px";
		const titleClone = printTitle.cloneNode(true);
		titleClone.style.marginBottom = "16px";
		exportWrapper.appendChild(titleClone);
		const canvasClone = canvas.cloneNode(true);
		exportWrapper.appendChild(canvasClone);
		document.body.appendChild(exportWrapper);

		const canvasImg = await html2canvas(exportWrapper, {
			scale: 4,
			backgroundColor: getComputedStyle(document.body).backgroundColor,
			useCORS: true,
			logging: false,
			removeContainer: true
		});
		exportWrapper.remove();
		const imgWidth = pageWidth;
		const imgHeight = canvasImg.height * imgWidth / canvasImg.width;
		if (addPage) pdf.addPage();
		pdf.addImage(canvasImg.toDataURL("image/png"), "PNG", 0, y, imgWidth, imgHeight);
	};

	for (let i = 1; i <= pageCount; i++) await capture(i, i > 1);
	loadPage(originalPage);
	ui.forEach(el => el.style.display = "");
	if (!showNumbers) document.querySelectorAll(".system-number").forEach(n => n.style.display = "");
	
	// R√©afficher les poign√©es
	document.querySelectorAll(".shorten-handle").forEach(h => h.style.display = "");
	
	pdf.save("tablature-barok.pdf");
	haptic();
}

/* ================= UI DRAG VERTICAL ================= */
function makeUIDraggableVertical(el, handleEl, storageKey) {
	let startY = 0, startTop = 0, dragging = false;
	handleEl.addEventListener("touchstart", e => {
		startY = e.touches[0].clientY;
		startTop = el.getBoundingClientRect().top;
		dragging = true; el.style.transition = "none"; e.stopPropagation();
	}, { passive: false });
	document.addEventListener("touchmove", e => {
		if (!dragging) return;
		e.preventDefault();
		let newTop = startTop + (e.touches[0].clientY - startY);
		newTop = Math.max(8, Math.min(window.innerHeight - el.offsetHeight - 8, newTop));
		el.style.top = newTop + "px"; el.style.bottom = "auto";
	}, { passive: false });
	document.addEventListener("touchend", () => {
		if (dragging) { localStorage.setItem(storageKey, el.style.top); el.style.transition = ""; dragging = false; }
	});
}
function restoreUIVerticalPosition(el, storageKey, defaultTop) {
	const saved = localStorage.getItem(storageKey);
	if (saved) { el.style.top = saved; el.style.bottom = "auto"; }
	else if (defaultTop) { el.style.top = defaultTop; el.style.bottom = "auto"; }
}

/* ================= INIT ================= */
restoreFromStorage();
renderPageNav();
restoreUIVerticalPosition(toolbar, "toolbarY", "8px");
restoreUIVerticalPosition(palette, "paletteY", null);
makeUIDraggableVertical(toolbar, document.getElementById("toolbarHandle"), "toolbarY");
makeUIDraggableVertical(palette, document.getElementById("paletteHandle"), "paletteY");
pushUndo();
</script>
</body>
</html>
