<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Tablature</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  font-family: serif;
  background: white;
  touch-action: none;
}

#canvas {
  position: relative;
  height: 70vh;
  touch-action: none;
}

#canvas.disabled {
  pointer-events: none; /* â¬… canvas totalement inerte */
}

.line {
  position: absolute;
  left: 5%;
  right: 5%;
  height: 1px;
  background: black;
}

.symbol {
  position: absolute;
  font-size: 22px;
  user-select: none;
  touch-action: none;
}

#controls {
  padding: 6px;
  border-top: 1px solid black;
}

button {
  font-size: 16px;
}

#palette {
  height: 30vh;
  overflow: auto;
  border-top: 1px solid black;
  padding: 8px;
  display: flex;
  flex-wrap: wrap;
}

.palette-item {
  border: 1px solid black;
  padding: 6px;
  margin: 4px;
  font-size: 20px;
}
</style>
</head>

<body>

<div id="canvas"></div>

<div id="controls">
  <button id="deleteToggle">ðŸ—‘ Effacer : OFF</button>
</div>

<div id="palette"></div>

<script>
// â›” BLOQUAGE TOTAL DU SCROLL iOS
document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });

const canvas = document.getElementById("canvas");
const palette = document.getElementById("palette");
const deleteBtn = document.getElementById("deleteToggle");

let deleteMode = false;
let selected = null;

// =======================
// LIGNES
// =======================
const lineYs = [];
for (let i = 0; i < 6; i++) {
  const y = 60 + i * 40;
  const line = document.createElement("div");
  line.className = "line";
  line.style.top = y + "px";
  canvas.appendChild(line);
  lineYs.push(y);
}

// =======================
// AIMANTATION CENTRÃ‰E
// =======================
function snapToLineCenter(y, el) {
  let closest = lineYs[0];
  let minDist = Math.abs(y - closest);
  for (let ly of lineYs) {
    const d = Math.abs(y - ly);
    if (d < minDist) {
      minDist = d;
      closest = ly;
    }
  }
  return closest - (el.offsetHeight || 22) / 2;
}

// =======================
// MODE EFFACER (clÃ©)
// =======================
deleteBtn.addEventListener("click", () => {
  deleteMode = !deleteMode;
  deleteBtn.textContent = deleteMode ? "ðŸ—‘ Effacer : ON" : "ðŸ—‘ Effacer : OFF";

  // â›” dÃ©sactivation totale du canvas
  canvas.classList.toggle("disabled", deleteMode);
});

// =======================
// PALETTE
// =======================
const symbols = [
  "a","b","c","d","e","f","g","h","j","k",
  "/a","//a","///a",
  "1","2","3","4","5","6","7","|"
];

symbols.forEach(sym => {
  const btn = document.createElement("div");
  btn.className = "palette-item";
  btn.textContent = sym;
  btn.addEventListener("touchstart", e => {
    e.preventDefault();
    selected = sym;
  }, { passive: false });
  palette.appendChild(btn);
});

// =======================
// CRÃ‰ATION (mode normal)
// =======================
canvas.addEventListener("touchstart", e => {
  if (deleteMode || !selected) return;

  e.preventDefault();
  const touch = e.touches[0];
  const rect = canvas.getBoundingClientRect();

  const s = document.createElement("div");
  s.className = "symbol";
  s.textContent = selected;

  s.style.left = (touch.clientX - rect.left) + "px";
  canvas.appendChild(s);
  s.style.top = snapToLineCenter(touch.clientY - rect.top, s) + "px";

  let startX, startY, offsetX, offsetY;

  s.addEventListener("touchstart", ev => {
    ev.preventDefault();

    // ðŸ—‘ SUPPRESSION GARANTIE
    if (deleteMode) {
      s.remove();
      return;
    }

    const t = ev.touches[0];
    startX = t.clientX;
    startY = t.clientY;
    offsetX = s.offsetLeft;
    offsetY = s.offsetTop;
  }, { passive: false });

  s.addEventListener("touchmove", ev => {
    if (deleteMode) return;
    ev.preventDefault();
    const t = ev.touches[0];
    s.style.left = (offsetX + t.clientX - startX) + "px";
    s.style.top = (offsetY + t.clientY - startY) + "px";
  }, { passive: false });

  s.addEventListener("touchend", () => {
    if (!deleteMode) {
      s.style.top = snapToLineCenter(
        s.offsetTop + s.offsetHeight / 2,
        s
      ) + "px";
    }
  });

}, { passive: false });

</script>

</body>
</html>
