<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>Tablature baroque</title>

<meta name="viewport"
content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English&display=swap" rel="stylesheet">

<style>
*{ touch-action: manipulation; }

html,body{
  margin:0;
  padding:0;
  height:100%;
  font-family:"IM Fell English", serif;
  overflow:hidden;
  background:white;
}

/* ===== TOOLBAR ===== */
#toolbar{
  position:fixed;
  top:0; left:0; right:0;
  display:flex;
  gap:6px;
  padding:6px;
  border-bottom:1px solid black;
  background:white;
  z-index:10;
}

button{
  padding:8px 12px;
  border:1px solid black;
  background:white;
  font-size:14px;
}
button.active{ background:black; color:white; }

#bgColor{
  width:34px;
  height:34px;
  border:1px solid black;
}

/* ===== CANVAS ===== */
#canvas-wrapper{
  position:absolute;
  top:54px;
  bottom:120px;
  left:-40px;
  right:-40px;
  overflow:auto;
}

#canvas{
  position:relative;
  width:794px;
  min-height:1123px;
  margin:0 auto;
  background:white;
}

/* ===== DRAW ===== */
.draw{ position:absolute; }
.draw path{
  fill:none;
  stroke:black;
  stroke-width:2;
  stroke-linecap:round;
  stroke-linejoin:round;
}
.draw.selected{ outline:2px dashed black; }

/* ===== TITLE ===== */
#print-title{
  text-align:center;
  font-size:34px;
  margin:30px 0 20px;
}

/* ===== LINES ===== */
.line{ position:absolute; left:0; right:0; height:2px; }
.line.black{ background:black; }
.line.white{ background:transparent; }

/* ===== SYMBOLS ===== */
.symbol{
  position:absolute;
  font-size:34px;
  white-space:nowrap;
  line-height:1;
  transform:translateY(-0.88em);
}

/* ===== BAR ===== */
.bar{
  position:absolute;
  width:4px;
  background:black;
}
.bar::before{
  content:"";
  position:absolute;
  left:-12px; right:-12px; top:0; bottom:0;
}

/* ===== SELECTION ===== */
.selected{
  outline:2px solid black;
  background:rgba(0,0,0,0.05);
}

/* ===== PALETTE ===== */
#palette{
  position:fixed;
  bottom:0; left:0; right:0;
  height:120px;
  border-top:1px solid black;
  background:white;
  display:flex;
  align-items:center;
  padding:6px;
  gap:4px;
  z-index:10;
  flex-wrap:wrap;
}
.palette-item{
  border:1px solid black;
  padding:8px 10px;
  font-size:26px;
  cursor:pointer;
}
.palette-item.active{ background:black; color:white; }

#customChar{
  margin-left:auto;
  width:60px;
  font-size:26px;
  text-align:center;
  border:1px solid black;
}

/* ===== SCROLL ===== */
#scroll-buttons{
  position:fixed;
  right:8px;
  bottom:130px;
  display:flex;
  flex-direction:column;
  gap:6px;
  z-index:10;
}
</style>
</head>

<body>

<div id="toolbar">
  <button id="editTitle">Titre</button>
  <button id="toolPlace" class="active">Placer</button>
  <button id="toolSelect">Sélection</button>
  <button id="undo">Retour</button>
  <button id="deleteBtn">Effacer</button>
  <button id="clearAllBtn">Tout effacer</button>
  <button id="addBlackLine">+ Ligne noire</button>
  <button id="addWhiteLine">+ Ligne blanche</button>
  <button id="addBar">+ Barre</button>
  <button id="toggleSnap" class="active">Accroché</button>
  <input type="color" id="bgColor">
  <button id="page1" class="active">Page 1</button>
  <button id="page2">Page 2</button>
</div>

<div id="canvas-wrapper">
  <div id="print-title"></div>
  <div id="canvas"></div>
</div>

<div id="palette"></div>

<div id="scroll-buttons">
  <button id="scrollUp">⬆</button>
  <button id="scrollDown">⬇</button>
</div>

<script>
/* ================= CONSTANTES ================= */
const LINE_SPACING = 28;
const DRAW_W = 80;
const DRAW_H = 60;
const MAX_UNDO = 40;

/* ================= ÉTAT ================= */
let tool = "place";
let selected = "a";
let selectedElement = null;
let active = null;
let snap = true;
let placingBar = false;
let drawing = false;
let currentPath = null;
let drawStart = {x:0,y:0};
let currentY = 40;
let scale = 1;
let currentPage = 1;

const lines = [];
const undoStack = [];
const pages = {1:null,2:null};

/* ================= DOM ================= */
const canvas = document.getElementById("canvas");
const wrapper = document.getElementById("canvas-wrapper");
const printTitle = document.getElementById("print-title");

/* ================= UNDO ================= */
function serializeState(){
  return JSON.stringify({
    title:printTitle.textContent,
    elements:[...canvas.children].map(el=>{
      if(el.classList.contains("draw")){
        return{
          type:"draw",
          left:el.style.left,
          top:el.style.top,
          d:el.querySelector("path").getAttribute("d")
        };
      }
      return{
        type:"node",
        class:el.className,
        text:el.textContent,
        left:el.style.left,
        top:el.style.top,
        height:el.style.height||""
      };
    })
  });
}

function pushUndo(){
  undoStack.push(serializeState());
  if(undoStack.length>MAX_UNDO) undoStack.shift();
}

function undo(){
  if(undoStack.length<2) return;
  undoStack.pop();
  restoreState(undoStack[undoStack.length-1]);
}
document.getElementById("undo").onclick=undo;

/* ================= RESTORE ================= */
function restoreState(raw){
  const s=JSON.parse(raw);
  canvas.innerHTML="";
  lines.length=0;
  currentY=40;
  printTitle.textContent=s.title||"";

  s.elements.forEach(e=>{
    if(e.type==="draw"){
      const w=document.createElement("div");
      w.className="draw";
      w.style.left=e.left;
      w.style.top=e.top;
      const svg=document.createElementNS("http://www.w3.org/2000/svg","svg");
      svg.setAttribute("width",DRAW_W);
      svg.setAttribute("height",DRAW_H);
      const p=document.createElementNS("http://www.w3.org/2000/svg","path");
      p.setAttribute("d",e.d);
      svg.appendChild(p);
      w.appendChild(svg);
      canvas.appendChild(w);
      makeDraggable(w);
      return;
    }

    const el=document.createElement("div");
    el.className=e.class;
    el.textContent=e.text;
    el.style.left=e.left;
    el.style.top=e.top;
    if(e.height) el.style.height=e.height;
    canvas.appendChild(el);

    if(el.classList.contains("line")){
      lines.push(parseFloat(e.top));
      currentY=parseFloat(e.top)+LINE_SPACING;
    }
    if(el.classList.contains("symbol")||el.classList.contains("bar")){
      makeDraggable(el);
    }
  });
}

/* ================= STRUCTURE ================= */
function addLine(type){
  const l=document.createElement("div");
  l.className="line "+type;
  l.style.top=currentY+"px";
  canvas.appendChild(l);
  lines.push(currentY);
  currentY+=LINE_SPACING;
}

function createInitialStructure(){
  addLine("white");
  for(let r=0;r<5;r++){
    for(let i=0;i<6;i++) addLine("black");
    if(r<4) for(let i=0;i<2;i++) addLine("white");
  }
  addLine("white");
}

/* ================= INIT ================= */
createInitialStructure();
pushUndo();

/* ================= PALETTE ================= */
[
 "a","b","c","d","e","f","g","h","j","k",
 "l","m","n",
 "/a","//a","///a","4","5","6",
 ",",".",":",";","(",")","[","]","~","⌒","|","✎"
].forEach(s=>{
  const p=document.createElement("div");
  p.className="palette-item";
  p.textContent=s;
  p.onclick=()=>{
    document.querySelectorAll(".palette-item")
      .forEach(i=>i.classList.remove("active"));
    p.classList.add("active");
    selected = (s==="✎") ? "__draw__" : s;
    tool="place";
  };
  document.getElementById("palette").appendChild(p);
});

/* ================= DRAG ================= */
function makeDraggable(el){
  el.addEventListener("touchstart",e=>{
    if(tool!=="select" && !el.classList.contains("draw")) return;
    pushUndo();
    selectedElement=el;
    el.classList.add("selected");
    active=el;
    e.stopPropagation();
  },{passive:false});

  el.addEventListener("touchmove",e=>{
    if(!active) return;
    e.preventDefault();
    const r=canvas.getBoundingClientRect();
    active.style.left=((e.touches[0].clientX-r.left)/scale)+"px";
    active.style.top=((e.touches[0].clientY-r.top)/scale)+"px";
  },{passive:false});

  el.addEventListener("touchend",()=>{
    if(active) active.classList.remove("selected");
    active=null;
  });
}
</script>

</body>
</html>
