<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>Tablature baroque</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  height:100%;
  font-family:"IM Fell English", serif;
  overflow:hidden;
  background:white;
}

/* ===== TOOLBAR ===== */
#toolbar{
  position:fixed;
  top:0;
  left:0;
  right:0;
  display:flex;
  gap:6px;
  padding:6px;
  border-bottom:1px solid black;
  background:white;
  z-index:10;
}

button{
  padding:8px 12px;
  border:1px solid black;
  background:white;
  font-size:14px;
}
button.active{
  background:black;
  color:white;
}

#bgColor{
  width:34px;
  height:34px;
  border:1px solid black;
}

/* ===== CANVAS ===== */
#canvas-wrapper{
  position:absolute;
  top:54px;
  bottom:120px;
  left:0;
  right:0;
  overflow-y:auto;
}

#canvas{
  position:relative;
  min-height:1800px;
}

/* ===== TITLE ===== */
#print-title{
  text-align:center;
  font-size:34px;
  margin:40px 0 50px;
}

/* ===== LINES ===== */
.line{
  position:absolute;
  left:6%;
  right:6%;
  height:2px;
}
.line.black{ background:black; }
.line.white{ background:transparent; }

/* ===== SYMBOLS ===== */
.symbol{
  position:absolute;
  font-size:34px;
  white-space:nowrap;
}

/* ===== BAR ===== */
.bar{
  position:absolute;
  width:4px;
  background:black;
}
.bar::before{
  content:"";
  position:absolute;
  left:-12px;
  right:-12px;
  top:0;
  bottom:0;
}

/* ===== SELECTION ===== */
.selected{
  outline:2px solid black;
  background:rgba(0,0,0,0.05);
}

/* ===== PALETTE ===== */
#palette{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:120px;
  border-top:1px solid black;
  background:white;
  display:flex;
  align-items:center;
  padding:6px;
  gap:4px;
  z-index:10;
  flex-wrap:wrap;
}

.palette-item{
  border:1px solid black;
  padding:8px 10px;
  font-size:26px;
  cursor:pointer;
}

#customChar{
  margin-left:auto;
  width:60px;
  font-size:26px;
  text-align:center;
  border:1px solid black;
}
</style>
</head>

<body>

<div id="toolbar">
  <button id="editTitle">Titre</button>
  <button id="toolPlace" class="active">Placer</button>
  <button id="toolSelect">Sélection</button>
  <button id="undo">Retour</button>
  <button id="deleteBtn">Effacer</button>
  <button id="clearAllBtn">Tout effacer</button>
  <button id="addBlackLine">+ Ligne noire</button>
  <button id="addWhiteLine">+ Ligne blanche</button>
  <button id="addBar">+ Barre</button>
  <button id="toggleSnap" class="active">Accroché</button>
  <input type="color" id="bgColor">
  <button id="exportPDF">PDF</button>
</div>

<div id="canvas-wrapper">
  <div id="print-title"></div>
  <div id="canvas"></div>
</div>

<div id="palette"></div>

<script>
/* ===== DOM ===== */
const canvas = document.getElementById("canvas");
const printTitle = document.getElementById("print-title");
const undoBtn = document.getElementById("undo");
const deleteBtn = document.getElementById("deleteBtn");
const clearAllBtn = document.getElementById("clearAllBtn");
const toolPlace = document.getElementById("toolPlace");
const toolSelect = document.getElementById("toolSelect");
const toggleSnap = document.getElementById("toggleSnap");

/* ===== STATE ===== */
let tool="place", snap=true, placingBar=false;
let selected="a", selectedElement=null, active=null;
let currentY=40;
const LINE_SPACING=28;
const lines=[];

/* ===== UNDO STACK ===== */
const undoStack=[];
const MAX_UNDO=30;

function pushUndo(){
  undoStack.push(JSON.stringify({
    title:printTitle.textContent,
    elements:[...canvas.children].map(el=>({
      class:el.className,
      text:el.textContent||"",
      left:el.style.left,
      top:el.style.top,
      height:el.style.height||""
    }))
  }));
  if(undoStack.length>MAX_UNDO) undoStack.shift();
}

function restoreState(state){
  const s=JSON.parse(state);
  canvas.innerHTML="";
  lines.length=0;
  currentY=40;
  printTitle.textContent=s.title||"";
  s.elements.forEach(e=>{
    const el=document.createElement("div");
    el.className=e.class;
    el.textContent=e.text;
    el.style.left=e.left;
    el.style.top=e.top;
    if(e.height) el.style.height=e.height;
    canvas.appendChild(el);
    if(el.classList.contains("line")){
      lines.push(parseFloat(e.top));
      currentY=parseFloat(e.top)+LINE_SPACING;
    }
    if(el.classList.contains("symbol")||el.classList.contains("bar")){
      makeDraggable(el);
    }
  });
}

/* ===== UNDO BUTTON ===== */
undoBtn.onclick=()=>{
  if(undoStack.length===0) return;
  restoreState(undoStack.pop());
};

/* ===== TOOLS ===== */
toolPlace.onclick=()=>tool="place";
toolSelect.onclick=()=>tool="select";
toggleSnap.onclick=()=>{
  snap=!snap;
  toggleSnap.classList.toggle("active",snap);
};

/* ===== PALETTE ===== */
[
 "a","b","c","d","e","f","g","h","j","k",
 "l","m","n",
 "/a","//a","///a","4","5","6",
 ",",".",":",";","(",")","[","]","~","⌒","|"
].forEach(s=>{
  const p=document.createElement("div");
  p.className="palette-item";
  p.textContent=s;
  p.onclick=()=>{selected=s; tool="place";};
  document.getElementById("palette").appendChild(p);
});

/* ===== SNAP ===== */
function nearestLine(y){
  return lines.reduce((a,b)=>Math.abs(b-y)<Math.abs(a-y)?b:a);
}
function snapY(y,s){
  if(!snap) return y;
  const b=nearestLine(y);
  if(s.startsWith("///")) return b+LINE_SPACING*0.55;
  if(s.startsWith("//")) return b+LINE_SPACING*0.40;
  if(s.startsWith("/")) return b+LINE_SPACING*0.25;
  return b+LINE_SPACING*0.15;
}

/* ===== INTERACTION ===== */
canvas.addEventListener("touchstart",e=>{
  if(tool!=="place") return;
  pushUndo();
  const r=canvas.getBoundingClientRect();
  const x=e.touches[0].clientX-r.left;
  const y=e.touches[0].clientY-r.top;
  const s=document.createElement("div");
  s.className="symbol";
  s.textContent=selected;
  s.style.left=x+"px";
  s.style.top=snapY(y,selected)+"px";
  canvas.appendChild(s);
  makeDraggable(s);
},{passive:false});

/* ===== DRAG ===== */
function makeDraggable(el){
  el.addEventListener("touchstart",e=>{
    if(tool!=="select") return;
    pushUndo();
    if(selectedElement) selectedElement.classList.remove("selected");
    selectedElement=el;
    el.classList.add("selected");
    active=el;
    e.stopPropagation();
  },{passive:false});

  el.addEventListener("touchmove",e=>{
    if(!active) return;
    const r=canvas.getBoundingClientRect();
    active.style.left=e.touches[0].clientX-r.left+"px";
    active.style.top=e.touches[0].clientY-r.top+"px";
    e.preventDefault();
  },{passive:false});

  el.addEventListener("touchend",()=>active=null);
}

/* ===== DELETE ===== */
deleteBtn.onclick=()=>{
  if(!selectedElement) return;
  pushUndo();
  selectedElement.remove();
  selectedElement=null;
};

/* ===== CLEAR ALL ===== */
clearAllBtn.onclick=()=>{
  if(!confirm("Effacer toute la tablature ?")) return;
  pushUndo();
  canvas.innerHTML="";
  lines.length=0;
  currentY=40;
};
</script>

</body>
</html>
