<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Tablature baroque</title>

<meta name="viewport"
content="width=device-width,
initial-scale=1.0,
maximum-scale=1.0,
user-scalable=no">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  height:100%;
  font-family:"IM Fell English",serif;
  background:white;
  overflow:hidden;
  -webkit-text-size-adjust:100%;
}

/* blocage zoom */
#canvas,#toolbar,#palette{
  touch-action:manipulation;
  user-select:none;
  -webkit-user-select:none;
}

#title{
  width:100%;
  text-align:center;
  font-size:34px;
  padding:10px 0;
  border:none;
  outline:none;
  user-select:text;
  -webkit-user-select:text;
  touch-action:auto;
}

/* toolbar */
#toolbar{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  padding:6px;
  border-top:1px solid black;
  border-bottom:1px solid black;
}

button{
  padding:6px 10px;
  border:1px solid black;
  background:white;
  font-size:14px;
}

button.active{
  background:black;
  color:white;
}

/* canvas */
#canvas{
  position:relative;
  height:55vh;
}

/* lignes */
.line{
  position:absolute;
  left:5%;
  right:5%;
  height:2px;
  background:black;
}

/* symboles */
.symbol{
  position:absolute;
  font-size:34px;
  white-space:nowrap;
}

/* barres */
.bar{
  position:absolute;
  width:3px;
  height:150px;
  background:black;
}

/* palette */
#palette{
  height:35vh;
  border-top:1px solid black;
  padding:8px;
  display:flex;
  flex-wrap:wrap;
}

.palette-item{
  border:1px solid black;
  padding:10px;
  margin:4px;
  font-size:30px;
}
</style>
</head>

<body>

<input id="title" placeholder="Titre du morceau">

<div id="toolbar">
  <button id="toolPlace" class="active">‚úçÔ∏è Placer</button>
  <button id="toolSelect">üñê S√©lection</button>
  <button id="toggleSnap" class="active">üß≤ Accroch√©</button>
  <button id="erase">‚ùå Effacer</button>
  <button id="addBar">‚ûï Barre</button>
  <button id="exportPDF">üìÑ PDF</button>
</div>

<div id="canvas"></div>
<div id="palette"></div>

<script>
/* anti-zoom iOS */
["gesturestart","gesturechange","gestureend","dblclick"].forEach(ev=>{
  document.addEventListener(ev,e=>e.preventDefault(),{passive:false});
});

/* variables */
const canvas=document.getElementById("canvas");
const palette=document.getElementById("palette");
let tool="place";
let snap=true;
let placingBar=false;
let active=null;

/* outils */
toolPlace.onclick=()=>setTool("place");
toolSelect.onclick=()=>setTool("select");
toggleSnap.onclick=()=>{
  snap=!snap;
  toggleSnap.textContent=snap?"üß≤ Accroch√©":"üîì Libre";
  toggleSnap.classList.toggle("active",snap);
};
function setTool(t){
  tool=t;
  toolPlace.classList.toggle("active",t==="place");
  toolSelect.classList.toggle("active",t==="select");
}

/* lignes de base */
const LINE_SPACING=30;
const lines=[];
for(let i=0;i<6;i++){
  const y=80+i*LINE_SPACING;
  lines.push(y);
  const l=document.createElement("div");
  l.className="line";
  l.style.top=y+"px";
  canvas.appendChild(l);
}

/* palette compl√®te */
[
"a","b","c","d","e","f","g","h","j","k",
"/a","//a","///a",
"1","2","3","4","5","6","7"
].forEach(t=>{
  const p=document.createElement("div");
  p.className="palette-item";
  p.textContent=t;
  p.onclick=()=>selected=t;
  palette.appendChild(p);
});
let selected="a";

/* barre */
addBar.onclick=()=>{
  placingBar=true;
  setTool("select");
};

/* canvas interaction */
canvas.addEventListener("touchstart",e=>{
  const r=canvas.getBoundingClientRect();
  const x=e.touches[0].clientX-r.left;
  const y=e.touches[0].clientY-r.top;

  /* effacer */
  if(tool==="select" && e.target!==canvas && erase.classList.contains("active")){
    e.target.remove();
    return;
  }

  /* placer barre */
  if(placingBar){
    placingBar=false;
    const b=document.createElement("div");
    b.className="bar";
    b.style.left=x+"px";
    b.style.top=y+"px";
    canvas.appendChild(b);
    makeDraggable(b);
    return;
  }

  /* placer symbole */
  if(tool==="place"){
    const s=document.createElement("div");
    s.className="symbol";
    s.textContent=selected;
    s.style.left=x+"px";
    s.style.top=(snap?nearestLine(y):y)+"px";
    canvas.appendChild(s);
    makeDraggable(s);
  }
},{passive:false});

/* drag */
function makeDraggable(el){
  el.addEventListener("touchstart",e=>{
    if(tool!=="select")return;
    active=el;
    e.stopPropagation();
  },{passive:false});

  el.addEventListener("touchmove",e=>{
    if(!active)return;
    const r=canvas.getBoundingClientRect();
    const x=e.touches[0].clientX-r.left;
    const y=e.touches[0].clientY-r.top;
    active.style.left=x+"px";
    active.style.top=(snap && active.classList.contains("symbol")?nearestLine(y):y)+"px";
    e.preventDefault();
  },{passive:false});

  el.addEventListener("touchend",()=>active=null);
}

/* effacer toggle */
erase.onclick=()=>{
  erase.classList.toggle("active");
};

/* snap helper */
function nearestLine(y){
  return lines.reduce((a,b)=>Math.abs(b-y)<Math.abs(a-y)?b:a);
}

/* export pdf */
exportPDF.onclick=async()=>{
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF("p","mm","a4");
  const img=await html2canvas(document.body,{scale:2});
  const w=210;
  const h=img.height*w/img.width;
  pdf.addImage(img.toDataURL("image/png"),"PNG",0,0,w,h);
  pdf.save("tablature.pdf");
};
</script>

</body>
</html>
