<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>Tablature baroque</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  height:100%;
  font-family:"IM Fell English", serif;
  overflow:hidden;
  background:white;
}

#toolbar{
  position:fixed;
  top:0;
  left:0;
  right:0;
  display:flex;
  gap:6px;
  padding:6px;
  border-bottom:1px solid black;
  background:white;
  z-index:10;
}

button{
  padding:8px 12px;
  border:1px solid black;
  background:white;
  font-size:14px;
}

#canvas-wrapper{
  position:absolute;
  top:54px;
  bottom:120px;
  left:0;
  right:0;
  overflow-y:auto;
}

#canvas{
  position:relative;
  min-height:1600px;
}

#print-title{
  text-align:center;
  font-size:34px;
  margin:40px 0 50px;
}

.line{
  position:absolute;
  left:6%;
  right:6%;
  height:2px;
  background:black;
}

.symbol{
  position:absolute;
  font-size:34px;
  white-space:nowrap;
}

#palette{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:120px;
  border-top:1px solid black;
  background:white;
  display:flex;
  align-items:center;
  gap:6px;
  padding:6px;
}

.palette-item{
  border:1px solid black;
  padding:10px 12px;
  font-size:26px;
}
</style>
</head>

<body>

<div id="toolbar">
  <button id="exportPDF">PDF</button>
</div>

<div id="canvas-wrapper">
  <div id="print-title">Titre</div>
  <div id="canvas"></div>
</div>

<div id="palette"></div>

<script>
const canvas = document.getElementById("canvas");
const palette = document.getElementById("palette");
const printTitle = document.getElementById("print-title");

let currentY = 40;
const spacing = 28;
const lines = [];

/* ===== INIT LINES ===== */
for(let block=0; block<4; block++){
  for(let i=0;i<6;i++){
    const l=document.createElement("div");
    l.className="line";
    l.style.top=currentY+"px";
    canvas.appendChild(l);
    lines.push(currentY);
    currentY+=spacing;
  }
  currentY+=spacing;
}

/* ===== PALETTE ===== */
let selected="a";
["a","b","c","d","e","f","g","h","j","k","/a","//a","///a","4","5","6"]
.forEach(s=>{
  const p=document.createElement("div");
  p.className="palette-item";
  p.textContent=s;
  p.onclick=()=>selected=s;
  palette.appendChild(p);
});

/* ===== SNAP ===== */
function snapY(y){
  return lines.reduce((a,b)=>Math.abs(b-y)<Math.abs(a-y)?b:a)-16;
}

/* ===== PLACE ===== */
canvas.addEventListener("click",e=>{
  const r=canvas.getBoundingClientRect();
  const s=document.createElement("div");
  s.className="symbol";
  s.textContent=selected;
  s.style.left=(e.clientX-r.left)+"px";
  s.style.top=snapY(e.clientY-r.top)+"px";
  canvas.appendChild(s);
});

/* ===== PDF ===== */
exportPDF.onclick=async()=>{
  const clone=document.createElement("div");
  clone.style.width="794px";
  clone.style.background="white";
  clone.innerHTML=printTitle.outerHTML+canvas.outerHTML;
  document.body.appendChild(clone);

  const img=await html2canvas(clone,{scale:3});
  const pdf=new window.jspdf.jsPDF("p","mm","a4");
  const w=210;
  const h=img.height*w/img.width;
  pdf.addImage(img.toDataURL("image/png"),"PNG",0,0,w,h);
  pdf.save("tablature.pdf");

  document.body.removeChild(clone);
};
</script>

</body>
</html>
