<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Tablature baroque</title>

<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English&display=swap" rel="stylesheet">

<style>
*{ box-sizing:border-box; touch-action:manipulation; }

html,body{
  margin:0; padding:0; height:100%;
  font-family:"IM Fell English", serif;
  background:white; overflow:hidden;
}

/* ===== TOOLBAR ===== */
#toolbar{
  position:fixed; top:0; left:0; right:0;
  display:flex; flex-wrap:wrap; gap:6px;
  padding:6px; background:white;
  border-bottom:1px solid black; z-index:10;
}
button{
  padding:8px 12px;
  border:1px solid black;
  background:white;
  font-size:14px;
}
button.active{
  background:black;
  color:white;
}
#bgColor{ width:34px; height:34px; border:1px solid black; }

/* ===== CANVAS ===== */
#canvas-wrapper{
  position:absolute;
  top:60px; bottom:120px; left:0; right:0;
  overflow:auto;
  background:white;
}
.page{
  position:relative;
  width:794px;
  min-height:1123px;
  margin:0 auto 40px auto;
  background:white;
}
.page-title{
  text-align:center;
  font-size:34px;
  margin:40px 0 20px;
}

/* ===== LINES ===== */
.line{
  position:absolute;
  left:0; right:0;
  height:2px;
}
.line.black{ background:black; }
.line.white{ background:transparent; }

/* ===== SYMBOLS ===== */
.symbol{
  position:absolute;
  font-size:34px;
  line-height:1;
  transform:translateY(-0.88em);
  cursor:grab;
}

/* ===== DRAW ===== */
.draw{ position:absolute; }
.draw path{
  fill:none;
  stroke:black;
  stroke-width:2;
  stroke-linecap:round;
  stroke-linejoin:round;
}
.selected{
  outline:2px solid black;
  background:rgba(0,0,0,0.05);
}

/* ===== BAR ===== */
.bar{
  position:absolute;
  width:4px;
  background:black;
}

/* ===== PALETTE ===== */
#palette{
  position:fixed;
  bottom:0; left:0; right:0;
  height:120px;
  display:flex; flex-wrap:wrap;
  gap:4px; padding:6px;
  border-top:1px solid black;
  background:white;
}
.palette-item{
  border:1px solid black;
  padding:8px 10px;
  font-size:26px;
  cursor:pointer;
}
.palette-item.active{
  background:black;
  color:white;
}
#customChar{
  margin-left:auto;
  width:60px;
  font-size:26px;
  text-align:center;
  border:1px solid black;
}

/* ===== SCROLL ===== */
#scroll-buttons{
  position:fixed;
  right:8px;
  bottom:130px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
</style>
</head>

<body>

<div id="toolbar">
  <button id="editTitle">Titre</button>
  <button id="toolPlace" class="active">Placer</button>
  <button id="toolSelect">Sélection</button>
  <button id="deleteBtn">Effacer</button>
  <button id="addBar">+ Barre</button>
  <button id="toggleSnap" class="active">Accroché</button>
  <input type="color" id="bgColor">
  <button id="page1" class="active">Page 1</button>
  <button id="page2">Page 2</button>
  <button id="page3">Page 3</button>
</div>

<div id="canvas-wrapper"></div>

<div id="palette"></div>

<div id="scroll-buttons">
  <button id="scrollUp">⬆</button>
  <button id="scrollDown">⬇</button>
</div>

<script>
/* ================= STATE ================= */
let tool="place";
let selected="a";
let selectedElement=null;
let placingBar=false;
let snap=true;

const LINE_SPACING=28;
const DRAW_W=80, DRAW_H=60;

/* ================= PAGES ================= */
let currentPage=1;
const pages={};

/* ================= INIT PAGES ================= */
function createPage(n){
  const el=document.createElement("div");
  el.className="page";
  el.style.display="none";

  const title=document.createElement("div");
  title.className="page-title";
  el.appendChild(title);

  pages[n]={ el, title, y:40, lines:[] };
  canvasWrapper.appendChild(el);
}

[1,2,3].forEach(createPage);

function switchPage(n){
  pages[currentPage].el.style.display="none";
  currentPage=n;
  pages[n].el.style.display="block";

  document.querySelectorAll("#page1,#page2,#page3")
    .forEach(b=>b.classList.remove("active"));
  document.getElementById("page"+n).classList.add("active");
}

switchPage(1);

/* ================= STRUCTURE ================= */
function addLine(type){
  const p=pages[currentPage];
  const l=document.createElement("div");
  l.className="line "+type;
  l.style.top=p.y+"px";
  p.el.appendChild(l);
  p.lines.push(p.y);
  p.y+=LINE_SPACING;
}

function initStructure(){
  addLine("white");
  for(let r=0;r<5;r++){
    for(let i=0;i<6;i++) addLine("black");
    if(r<4) for(let i=0;i<2;i++) addLine("white");
  }
  addLine("white");
}

[1,2,3].forEach(n=>{
  switchPage(n);
  initStructure();
});
switchPage(1);

/* ================= TITLE ================= */
editTitle.onclick=()=>{
  const t=prompt("Titre :", pages[currentPage].title.textContent||"");
  if(t===null) return;
  Object.values(pages).forEach(p=>p.title.textContent=t.trim());
};

/* ================= SNAP ================= */
function nearestLine(y){
  const a=pages[currentPage].lines;
  return a.reduce((p,c)=>Math.abs(c-y)<Math.abs(p-y)?c:p);
}
function snapY(y){
  return snap ? nearestLine(y)+LINE_SPACING/2 : y;
}
toggleSnap.onclick=()=>{
  snap=!snap;
  toggleSnap.classList.toggle("active",snap);
};

/* ================= INTERACTION ================= */
function pageRect(){
  return pages[currentPage].el.getBoundingClientRect();
}

pages[currentPage].el.addEventListener("touchstart",e=>{
  const r=pageRect();
  const x=e.touches[0].clientX-r.left;
  const y=e.touches[0].clientY-r.top;

  if(tool==="place" && selected){
    if(placingBar){
      placingBar=false;
      const b=document.createElement("div");
      b.className="bar";
      b.style.left=x+"px";
      b.style.top=nearestLine(y)+"px";
      b.style.height=(5*LINE_SPACING)+"px";
      pages[currentPage].el.appendChild(b);
      makeDraggable(b);
      return;
    }

    const s=document.createElement("div");
    s.className="symbol";
    s.textContent=selected;
    s.style.left=x+"px";
    s.style.top=snapY(y)+"px";
    pages[currentPage].el.appendChild(s);
    makeDraggable(s);
  }
},{passive:false});

/* ================= DRAG ================= */
function makeDraggable(el){
  el.addEventListener("touchstart",e=>{
    if(tool!=="select") return;
    if(selectedElement) selectedElement.classList.remove("selected");
    selectedElement=el;
    el.classList.add("selected");
    e.stopPropagation();
  },{passive:false});

  el.addEventListener("touchmove",e=>{
    if(!selectedElement) return;
    const r=pageRect();
    selectedElement.style.left=(e.touches[0].clientX-r.left)+"px";
    selectedElement.style.top =(e.touches[0].clientY-r.top)+"px";
  },{passive:false});
}

/* ================= DELETE ================= */
deleteBtn.onclick=()=>{
  if(!selectedElement) return;
  selectedElement.remove();
  selectedElement=null;
};

/* ================= TOOLS ================= */
toolPlace.onclick=()=>{
  tool="place";
  toolPlace.classList.add("active");
  toolSelect.classList.remove("active");
};
toolSelect.onclick=()=>{
  tool="select";
  toolSelect.classList.add("active");
  toolPlace.classList.remove("active");
};

/* ================= BAR ================= */
addBar.onclick=()=>{
  placingBar=true;
  tool="place";
};

/* ================= PALETTE ================= */
[
 "a","b","c","d","e","f","g","h","j","k",
 "l","m","n","/a","//a","///a","4","5","6",
 ",",".",":",";","(",")","[","]","~","⌒","|"
].forEach(ch=>{
  const p=document.createElement("div");
  p.className="palette-item";
  p.textContent=ch;
  p.onclick=()=>{
    document.querySelectorAll(".palette-item").forEach(x=>x.classList.remove("active"));
    p.classList.add("active");
    selected=ch;
    tool="place";
  };
  palette.appendChild(p);
});
</script>
</body>
</html>
